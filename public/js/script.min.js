"use strict";jQuery.fn.extend({insertAtCaret:function(myValue){return this.each((function(i){if(document.selection){this.focus(),document.selection.createRange().text=myValue,this.focus()}else if(this.selectionStart||0===this.selectionStart){let startPos=this.selectionStart,endPos=this.selectionEnd,scrollTop=this.scrollTop;this.value=this.value.substring(0,startPos)+myValue+this.value.substring(endPos,this.value.length),this.focus(),this.selectionStart=startPos+myValue.length,this.selectionEnd=startPos+myValue.length,this.scrollTop=scrollTop}else this.value+=myValue,this.focus()}))}}),window.IL=[],window.tables=[];let _=window._,B=window.Backbone;$.widget("il.typeahead",{searchId:"",ignoredKeys:[9,13,16,17,18,20,27,33,34,35,36,37,38,39,40,45],options:{delay:300,minLength:0,source:""},_getCreateOptions:function(){return{delay:this.element.attr("data-delay"),minLength:this.element.attr("data-minLength"),source:this.element.attr("data-source")}},_create:function(){this._on(this.element,{input:this._search,focus:this._search});let $menu=this.element.parent().next();this._on($menu,{"click button":function(e){this.element.val($(e.target).text()).attr("data-id",$(e.target).attr("data-id")),this._clearMenus(),this._trigger("onSelect",null,{element:this.element})}}),this._on($menu,{"keyup button":function(e){e.stopPropagation(),38===e.which&&$(e.target).prev().focus(),40===e.which&&$(e.target).next().focus(),27===e.which&&(this.element.focus(),this._clearMenus())}}),this._on("body",{click:this._clearMenus}),this._on(this.element.closest(".typeahead"),{click:function(e){e.stopPropagation()}}),this._on(this.window,{resize:this._resizeMenus})},_search:function(e){return 9===e.which||40===e.which?($(".typeahead").find("button:first").focus(),!1):(27===e.which&&this._clearMenus(),this.element.val().length<this.options.minLength?(this._clearMenus(),!1):-1===this.ignoredKeys.indexOf(e.which)&&(clearTimeout(this.searchId),void(this.searchId=this._delay(this._load,this.options.delay))))},_load:function(){let typeahead=this,$t=this.element,$menu=$t.parent().next();$.when(model.load({url:this.options.source,data:{q:this.element.val()}})).done((function(response){if(""===response.html)return void typeahead._clearMenus();$menu.width($t.outerWidth()-2).show().prev().attr("aria-expanded",!0);let popper=new Popper($t[0],$menu[0],{placement:"bottom",eventsEnabled:!0,positionFixed:!0,modifiers:{preventOverflow:{enabled:!1},hide:{enabled:!1}}});$menu.html(response.html),popper.update()}))},_clearMenus:function(){$(".typeahead .dropdown-menu").hide().empty().prev().attr("aria-expanded",!1)},_resizeMenus:function(){$(".typeahead .dropdown-menu").each((function(){$(this).width($(this).parent().outerWidth()-2)}))}}),$.widget("il.filterable",{event:"",searchStr:"",searchId:"",options:{container:"",minLength:1,source:"",targets:""},_getCreateOptions:function(){return{container:this.element.attr("data-container"),minLength:this.element.attr("data-minLength"),source:this.element.attr("data-source"),targets:this.element.attr("data-targets")}},_create:function(){this._on(this.element,{input:$.proxy(this,"_filter")}),this._addClass("filterable")},_filter:function(e){if(this.event=e,this.element.val()===this.searchStr)return!1;this.searchStr=this.element.val(),this.searchStr.replace("=","").length<this.options.minLength&&(this.searchStr=""),clearTimeout(this.searchId),""!==this.options.source&&""!==this.options.container?this.searchId=this._delay(this._remoteSearch,400):""!==this.options.targets&&(this.searchId=this._delay(this._localSearch,200))},_localSearch:function(){let escStr=this._escapeRegexp(this.searchStr),patt=new RegExp(escStr,"ui"),patt2=new RegExp("("+escStr+")","gui");0===escStr.indexOf("=")&&(patt=new RegExp("^"+escStr.substring(1),"ui"),patt2=new RegExp("^("+escStr.substring(1)+")","gui")),this.searchStr.length>=this.options.minLength?($(this.options.targets).addClass("d-none"),$(this.options.targets).filter((function(){let $t=$(this),txt=$t.text(),b=patt.test(txt);return!0===b&&$t.html(txt.replace(patt2,'<mark class="px-0">$1</mark>')),b})).removeClass("d-none")):$(this.options.targets).removeClass("d-none").each((function(){let $t=$(this);$t.html($t.text())})),this._trigger("complete",this.event)},_remoteSearch:function(){let This=this,href=this.options.source,cont=this.options.container;$.when(model.load({url:href,data:{q:This.searchStr}})).done((function(response){$(cont).replaceWith(response.html),This._trigger("complete",This.event)}))},_escapeRegexp:function(str){let patt=new RegExp("[\\"+["[","]","/","{","}","(",")","*","+","?",".","\\","^","$","|"].join("\\")+"]","gui");return str.replace(patt,"\\$&")}}),$.widget("il.expandable",{table:'<div class="il-expandable"></div>',cell1:'<div class="il-expandable-left">                 <button class="btn btn-sm btn-secondary" aria-controls="">                     <span class="mdi mdi-chevron-right"></span>                 </button>             </div>',cell2:'<div class="il-expandable-right" aria-expanded="true"></div>',_create:function(){this._expandability(),this._on(this.window,{resize:this._expandability})},_expandability:function(){if(this.element.innerHeight()>40&&0===this.element.find(".il-expandable-left").length){this.element.wrapInner(this.cell2).wrapInner(this.table),this.element.children().prepend(this.cell1);let eid="il-expandable-"+this.uuid;this.element.find(".il-expandable-left").find("button").attr("aria-controls",eid),this.element.find(".il-expandable-right").attr("id",eid).attr("aria-expanded","false").addClass("text-truncate"),this._on(this.element,{"click .il-expandable-left > button":this._toggle})}},_toggle:function(){this.element.find(".il-expandable-left").find(".mdi").toggleClass("mdi-chevron-right mdi-chevron-down"),this.element.find(".il-expandable-right").toggleClass("text-truncate").attr("aria-expanded",(function(i,attr){return"false"===attr?"true":"false"}))}}),$.widget("il.clonable",{options:{target:""},_create:function(){""!==this.options.target&&(this._addClass($(this.options.target),"clonable-target-"+this.uuid),this._on(this.element,{click:this._clone}),this._on(this.element.next(".remove-clone-button"),{click:this._removeClone}))},_clone:function(){let $target=$(this.options.target),parClass="clonable-target-"+this.uuid,clonedEl=$target.clone();$target.removeAttr("id"),clonedEl.find("[id]").each((function(){let eid=$(this).attr("id"),uid=_.uniqueId();$(this).attr("id",eid+"-"+uid),clonedEl.find('[for="'+eid+'"]').attr("for",eid+"-"+uid)})),clonedEl.find("[name]").each((function(){let newName=$(this).attr("name").replace(/\[(\d+)]/,(function(match,number){return"["+(parseInt(number)+1)+"]"}));$(this).attr("name",newName)})),clonedEl.find('[type="text"], [type="number"]').each((function(){this.value=""})),clonedEl.insertAfter($("."+parClass).last()),formStyle.init(),this._trigger("onClone",null,{clonedTarget:clonedEl[0]})},_removeClone:function(){let parClass="clonable-target-"+this.uuid,$clones=$("."+parClass),$last=$clones.last(),targetId=$last.attr("id");$clones.length<2||($last.remove(),$("."+parClass).last().attr("id",targetId))}}),$.widget("il.confirmable",{options:{target:"#modal-confirm",title:"Confirmation",body:"Confirm?",button:"Yes",submit:function(){}},_getCreateOptions:function(){return{target:this.element.data("target"),title:this.element.data("title"),body:this.element.data("body"),button:this.element.data("button")}},_create:function(){this._on(this.element,{click:this._modal})},_modal:function(){let confirmable=this,$m=$(this.options.target),$btn=$m.find(".modal-footer > button").eq(0);$m.find(".modal-title").html(this.options.title),$m.find(".modal-body").html(this.options.body),$m.find(".modal-footer > button").eq(0).html(this.options.button),formStyle.init(),$m.modal("show"),$($btn).off("click").on("click",(function(e){confirmable._trigger("submit",e),$m.modal("hide")}))}}),$.widget("il.saveable",{_create:function(){"form"===this.element.get(0).nodeName.toLowerCase()&&void 0!==this.element.attr("id")&&(this._on(this.element,{save:this.save}),this.load())},save:function(){let $f=this.element,saveParams=[],params=this.element.serializeArray();_.forEach(params,(function(v,i){"hidden"!==$f.find('input[name="'+v.name+'"]').attr("type")&&saveParams.push({name:v.name,value:v.value})})),store.save("saveable."+this.element.attr("id"),saveParams)},load:function(){let clonedNum=0,This=this,formData=store.load("saveable."+this.element.attr("id"))||[];this.element.get(0).reset(),this.element.find(":checkbox").prop("checked",!1),_.forEach(formData,(function(o){let input=This.element.find("[name='"+o.name+"']");0===input.length&&clonedNum<3&&(This.element.find(".clone-button").trigger("click"),clonedNum++,input=This.element.find("[name='"+o.name+"']")),input.val([o.value])})),formStyle.updateForm(this.element)},saveParams:function(params){store.save("saveable."+this.element.attr("id"),params)}}),$.widget("il.uploadable",{options:{multiple:!1,maxFiles:1e3},maxFilesMessage:"Maximum number of files reached.",maxSizeMessage:"File <b>{{filename}}</b> exceeds the size limit of {{limit}} MB.",fileItem:'<div class="file-container" data-file="{{filename}}">\n                   <div class="text-truncate mt-1">\n                        {{filename}}\n                   </div>\n                   <div style="height: 2rem">\n                       <div class="progress rounded-0 mb-1 bg-darker-5" style="height: 4px">\n                           <div class="progress-bar" role="progressbar" style="width: 1%" aria-valuenow="1" aria-valuemin="0" aria-valuemax="100"></div>\n                       </div>\n                       <span class="d-none spinner-border spinner-border-sm text-danger" role="status" style="margin-bottom: 0.2rem">\n                           <span class="sr-only">Saving...</span>\n                       </span>\n                       <span class="d-none mdi mdi-18px mdi-content-save text-danger ml-1"></span>\n                    </div>\n               </div>',_getCreateOptions:function(){return{multiple:!0===this.element.find(":file").prop("multiple")}},_create:function(){void 0===IL.uploader&&(IL.uploader={}),this._on(this.element,{submit:this._submit}),this._on(this.element.find(".uploadable-url"),{keydown:this._urlSubmit}),this._on(this.element.find(".uploadable-clear"),{click:this._clearFiles}),this._on(this.element.find(":file"),{change:this._pdfTitle});let uploadable=this,buttonSelect=this.element.find(".uploadable-select"),buttonClear=this.element.find(".uploadable-clear"),listDiv=this.element.find(".uploadable-list"),maxSize=Math.min(window.MAX_UPLOAD,window.MAX_POST),totalSize=0,loaded=0;IL.uploader[this.uuid]=new window.ss.SimpleUpload({button:buttonSelect,url:uploadable.element.attr("action"),name:uploadable.element.find(":file").attr("name"),form:uploadable.element,responseType:"json",overrideSubmit:!1,maxSize:maxSize/1024,multiple:uploadable.options.multiple,multipleSelect:uploadable.options.multiple,autoSubmit:!1,dropzone:uploadable.element,dragClass:"outline-standout",onChange:function(filename,extension,uploadBtn,fileSize,fileObj){if(!1===uploadable.options.multiple&&this.clearQueue(),this.getQueueSize()>=uploadable.options.maxFiles)return $.jGrowl(uploadable.maxFilesMessage,{header:"Info",sticky:!1,theme:"bg-primary"}),!1;uploadable._addFile(fileObj),totalSize+=fileSize,listDiv.children("div").eq(0).removeClass("d-none"),buttonClear.removeClass("d-none"),"application/pdf"===fileObj.type&&uploadable._pdfTitle(fileObj)},onSubmit:function(filename){this.setProgressContainer(uploadable.element.find('div[data-file="'+_.escape(filename)+'"]')),this.setProgressBar(uploadable.element.find('div[data-file="'+_.escape(filename)+'"] .progress-bar'))},onProgress(pct){if(100===pct){uploadable.element.find(".file-container").each((function(){"width: 1%"!==$(this).find(".progress-bar").attr("style")&&$(this).find(".spinner-border, .mdi").removeClass("d-none")}))}},onSizeError:function(filename,fileSize){let message=uploadable.maxSizeMessage.replace(/{{filename}}/,_.escape(filename)).replace(/{{limit}}/,maxSize/1048576);$.jGrowl(message,{header:"Info",sticky:!1,theme:"bg-primary"}),totalSize-=fileSize,this.getQueueSize()>0&&this.submit()},onDone:function(filename,status,statusText,response,uploadBtn,fileSize){loaded+=fileSize;let totalPct=100*loaded/totalSize;uploadable.element.find(".uploadable-progress .progress-bar").attr("aria-valuenow",totalPct).css("width",totalPct+"%"),this.getQueueSize()>0&&this.submit()},onAllDone:function(){this.destroy(),$.jGrowl("Upload has finished.",{header:"Info",theme:"bg-primary"}),B.history.loadUrl()},onError:function(filename,errorType,status,statusText,response){let xhr={status:status,statusText:statusText,responseJSON:JSON.parse(response)};model._onFail(xhr),this.getQueueSize()>0&&this.submit()}})},_addFile:function(fileObj){let item=this.fileItem.replace(/{{filename}}/g,_.escape(fileObj.name)),$cont=this.element.find(".uploadable-list").find(".list-group-item").eq(1).children();!0===this.options.multiple?$cont.append(item):$cont.html(item),this.element.find(".uploadable-list").removeClass("d-none"),this._trigger("change",null,fileObj)},_submit:function(e){e.preventDefault(),"object"==typeof IL.uploader[this.uuid]&&IL.uploader[this.uuid].getQueueSize()>0?IL.uploader[this.uuid].submit():$.when(model.save({url:this.element.attr("action"),data:this.element.serialize()})).done((function(){B.history.loadUrl()}))},_urlSubmit:function(e){if(13===e.which)return this.element.trigger("submit"),!1},_clearFiles:function(){this.element.find(".uploadable-list").addClass("d-none"),this.element.find(".uploadable-list").find(".list-group-item").eq(1).children().empty(),this.element.find(".uploadable-clear").addClass("d-none"),IL.uploader[this.uuid].clearQueue(),this._trigger("clear")},_pdfTitle:function(FileListObj){if("function"!=typeof this.options.pdftitles)return!1;if(FileListObj.size>5242880)return this._trigger("pdftitles",null,{titles:[]}),!1;let widget=this,reader=new FileReader,extractTitles=function(){let result,content=reader.result,regex=new RegExp(/<dc:title[\s\S]+?\/dc:title>/g),titles=[],i=0;for(;result=regex.exec(content);){let $xml=$(result[0]);titles[i]=$.trim($xml.text()),i++}titles=titles.filter(Boolean);let titleOutput=0===titles.length?[]:titles;widget._trigger("pdftitles",null,{titles:titleOutput}),reader.removeEventListener("load",extractTitles),reader=null};reader.addEventListener("load",extractTitles),reader.readAsText(FileListObj)}}),$.jGrowl.defaults.pool=3,$.jGrowl.defaults.life=5e3,$.jGrowl.defaults.position="top-right",$.jGrowl.defaults.closeTemplate='<span class="mdi mdi-window-close" aria-label="Close alert"></span>',$.jGrowl.defaults.closerTemplate="<button>CLOSE ALL</button>";class Overlay{constructor(){this.delay=800,this.timeId=null,this.template='<div id="overlay" class="d-flex align-items-center" style="display:none" aria-hidden="true">\n                             <span class="mx-auto mdi mdi-orbit mdi-spin text-danger"></span>\n                         </div>'}start(delay){let This=this;return"number"==typeof this.timeId&&this.stop(),delay="number"==typeof delay?delay:this.delay,this.timeId=setTimeout((function(){let $el=$("#overlay");0===$el.length&&($("body").append(This.template),$el.fadeIn(250,(function(){})))}),delay),!0}stop(){let $el=$("#overlay");return clearTimeout(this.timeId),this.timeId=null,$el.length>0&&$el.fadeOut(150,(function(){$el.remove()})),!0}}let overlay=new Overlay;class LocalStore{save(key,value){if(null==value||"function"==typeof value)return!1;localStorage.setItem(key,this._serialize(value))}load(key){return this._unserialize(localStorage.getItem(key))}delete(key){localStorage.removeItem(key)}clear(){localStorage.clear()}_serialize(value){return JSON.stringify(value)}_unserialize(value){return JSON.parse(value)}}let store=new LocalStore;class SessionStore{save(key,value){if(null==value||"function"==typeof value)return!1;sessionStorage.setItem(key,this._serialize(value))}load(key){return this._unserialize(sessionStorage.getItem(key))}delete(key){sessionStorage.removeItem(key)}clear(){sessionStorage.clear()}_serialize(value){return JSON.stringify(value)}_unserialize(value){return JSON.parse(value)}}let sessionStore=new SessionStore;class FormStyle{init(){let This=this;$(":checkbox, :radio").each((function(){This.updateStyle($(this))})).off("change.formstyle").on("change.formstyle",(function(){This.changeState($(this))})).off("focus.formstyle").on("focus.formstyle",(function(){$(this).next().find(".label-text").css("text-decoration","underline dotted 1px")})).off("blur.formstyle").on("blur.formstyle",(function(){$(this).next().find(".label-text").css("text-decoration","none")}))}changeState(el){let This=this;$('input[name="'+el.attr("name")+'"]').each((function(){This.updateStyle($(this))}))}updateStyle(el){let $icon=el.next().find(".mdi");"radio"===el.attr("type")?!0===el.prop("checked")?$icon.removeClass("mdi-radiobox-blank").removeClass("text-muted").addClass("mdi-radiobox-marked text-primary"):$icon.removeClass("mdi-radiobox-marked").removeClass("text-primary").addClass("mdi-radiobox-blank text-muted"):"checkbox"===el.attr("type")&&(!0===el.prop("checked")?$icon.removeClass("mdi-checkbox-blank-outline").removeClass("text-muted").addClass("mdi-checkbox-marked text-primary"):$icon.removeClass("mdi-checkbox-marked").removeClass("text-primary").addClass("mdi-checkbox-blank-outline text-muted"))}updateForm($form){let This=this;$form.find(":checkbox, :radio").each((function(){This.updateStyle($(this))}))}}let formStyle=new FormStyle;class Keyboard{init(){let $kw=$("#keyboard-window");!0!==$kw.hasClass("d-lg-block")?($kw.addClass("d-lg-block"),0===$kw.length&&$.when(model.load({url:window.IL_BASE_URL+"index.php/keyboard"})).done((function(response){$("body").append(response.html);let $kw=$("#keyboard-window");$kw.position({my:"bottom",at:"bottom",of:"body"}),$(window).off("resize.keyboard").on("resize.keyboard",(function(){$kw.position({my:"bottom",at:"bottom",of:"body"})})),$kw.draggable({handle:".card-header",containment:"body"}),$kw.find(".close").off("click.keyboard").on("click.keyboard",(function(){$kw.removeClass("d-lg-block")})),$kw.find(".tab-content").on("mousedown",(function(){return!1})),$("#keyboard").on("click",".btn",(function(){let char=$(this).html();1===$("#notes-ta_ifr").length?tinymce.execCommand("mceInsertContent",!1,char):$(":focus").insertAtCaret(char).trigger("input")}))}))):$kw.removeClass("d-lg-block")}}let keyboard=new Keyboard;class ExportForm{init(){let ctrl=decodeURIComponent($("#open-export").data("exportUrl")).indexOf("index.php/summary")>0?"summary":"items",$w=$("#modal-export");""===$.trim($w.find(".modal-body").html())&&$.when(model.load({url:window.IL_BASE_URL+"index.php/"+ctrl+"/exportform"})).done((function(response){$w.find(".modal-body").append(response.html),formStyle.init(),$("#export-form").saveable(),$w.find(".modal-footer button:first-child").off("click").on("click",(function(){exportform.formSubmit()})),$("#export-styles").typeahead(),$("#export-styles").off("focus").on("focus",(function(){$w.find('[name="export"]').val(["citation"]),formStyle.updateForm($("#export-form"))}))}))}formSubmit(){let exportUrl=decodeURIComponent($("#open-export").data("exportUrl")),$f=$("#export-form"),sep=""===new URL(exportUrl).search?"?":"&";window.open(exportUrl+sep+$f.serialize()),$f.saveable("save")}}let exportform=new ExportForm;class OmnitoolForm{init(){let $w=$("#modal-omnitool");if(""===$.trim($w.find(".modal-body").html()))$.when(model.load({url:window.IL_BASE_URL+"index.php/items/omnitoolform"})).done((function(response){$w.find(".modal-body").append(response.html),formStyle.init(),$w.find(".modal-footer button:first-child").on("click",(function(){omnitoolform.formSubmit()})),$("#tag-filter-omnitool").filterable({complete:function(){$("#omnitool-tags .label-text").each((function(){$(this).hasClass("d-none")?$(this).parent().parent().addClass("d-none"):$(this).parent().parent().removeClass("d-none")})),$("#omnitool-tags .tag-table").find("tr").each((function(){$(this).find(".label-text").length-$(this).find(".label-text.d-none").length==0?$(this).addClass("d-none"):$(this).removeClass("d-none")}))}})}));else{let $f=$w.find("form");$f[0].reset(),formStyle.updateForm($f)}}formSubmit(){let omnitoolUrl=decodeURIComponent($("#open-omnitool").data("omnitoolUrl")),$f=$("#modal-omnitool").find("form");$("#modal-omnitool").modal("hide"),$.when(model.save({url:omnitoolUrl,data:$f.serialize()})).done((function(){B.history.loadUrl()}))}}let omnitoolform=new OmnitoolForm;class QuickSearch{init(){let This=this,$f=$("#quick-search-form");$f.off("submit").on("submit",(function(e){e.preventDefault(),This.formSubmit()})),$("#modal-quick-search .modal-footer").find("button.search-submit").off("click").on("click",(function(){This.formSubmit()})),$f.saveable()}formSubmit(){let $m=$("#modal-quick-search"),$f=$("#quick-search-form"),sep=""===new URL("http://foo.bar/"+$f.attr("action").substr(1)).search?"?":"&";$f.saveable("save"),router.navigate($f.attr("action")+sep+$f.serialize(),{trigger:!0}),$m.modal("hide")}}let quicksearch=new QuickSearch;class AdvancedSearch{init(){let This=this,$f=$("#advanced-search-form");$f.off("submit").on("submit",(function(e){e.preventDefault(),This.formSubmit()})),$("#modal-advanced-search .modal-footer").find("button.search-submit").off("click").on("click",(function(){This.formSubmit()})),$("#advanced-search-form .clone-button").clonable({target:"#clone-target",onClone:function(e,t){$(t.clonedTarget).find("select.fields").trigger("change")}}),$f.saveable(),$f.on("change","select.fields",this.hideBooleans),this.hideBooleans(),$("#tag-filter-search").filterable({complete:function(){$("#search-tags .label-text").each((function(){$(this).hasClass("d-none")?$(this).parent().parent().addClass("d-none"):$(this).parent().parent().removeClass("d-none")})),$("#search-tags .tag-table").find("tr").each((function(){$(this).find(".label-text").length-$(this).find(".label-text.d-none").length==0?$(this).addClass("d-none"):$(this).removeClass("d-none")}))}})}formSubmit(){let $m=$("#modal-advanced-search"),$f=$("#advanced-search-form"),sep=""===new URL("http://foo.bar/"+$f.attr("action").substr(1)).search?"?":"&";$f.saveable("save"),router.navigate($f.attr("action")+sep+$f.serialize(),{trigger:!0}),$m.modal("hide")}hideBooleans(e){let hide,selects=void 0===e?$("#advanced-search-form").find("select.fields"):$(this);$.each(selects,(function(i,select){switch($(select).val()){case"AU":case"T1":case"T2":case"T3":case"KW":case"YR":case"C1":case"C2":case"C3":case"C4":case"C5":case"C6":case"C7":case"C8":hide=!0;break;default:hide=!1}hide?$(select).closest(".row").removeClass("text-search").addClass("string-search"):$(select).closest(".row").removeClass("string-search").addClass("text-search")}))}}let advancedsearch=new AdvancedSearch;class SearchList{init(){$("#modal-searches").on("show.bs.modal",searchlist.load)}load(e){let $w=$("#modal-searches");$.when(model.load({url:window.IL_BASE_URL+"index.php/search/list",async:!0})).done((function(response){$w.find(".modal-body").html(response.html),$w.find(".modal-body").on("click",".delete-search",searchlist.deleteSearch)}))}deleteSearch(e){let $t=$(this);$.when(model.save({url:$t.data("url"),data:{id:$t.data("id")}})).done((function(){searchlist.load()}))}}let searchlist=new SearchList;class Sidebar{init(){let This=this,$sm=$("#side-menu"),$nt=$(".navbar-toggler");$(window).on("popstate",(function(){let path=location.hash.split("?")[0],$l=$sm.find('a[href^="'+path+'"]');if(0!==$l.length){if($sm.find("a").removeClass("clicked"),""===location.hash||"#"===location.hash)return!0;This.expandSidebar($l)}})),$sm.metisMenu();let path=location.hash.split("?")[0],$l=$sm.find('a[href^="'+path+'"]');if(0===$l.length){let h=_.dropRight(location.hash.split("/"));$l=$sm.find('a[href="'+h+'"]')}this.expandSidebar($l),$sm.on("click","a",(function(){location.hash===$(this).attr("href")&&B.history.loadUrl(),""!==$(this).attr("href")&&"#"!==$(this).attr("href")&&$nt.is(":visible")&&$nt.trigger("click")}))}expandSidebar($l){$l.parents("ul.collapse").not(".in").each((function(){$(this).addClass("in").prev().click()})),$l.addClass("clicked")}}let sidebar=new Sidebar;class ImageFilter{constructor(){this.touchDevice=window.matchMedia("(max-width: 1199px)").matches,this.default={contrast:"1",brightness:"1",saturation:"1",hue:"0deg",invert:"0",sharpen:!1,sharpness:"0"}}compileCss(sharpen){let nightMode=$(".pdfviewer-right > div:first").hasClass("img-night-mode"),contrast=$("#adjust-contrast").val()||this.default.contrast,brightness=$("#adjust-brightness").val()||this.default.brightness,saturation=$("#adjust-saturation").val()||this.default.saturation,sharpness=$("#adjust-sharpness").val()||this.default.sharpness,f=`contrast(${contrast}) brightness(${brightness}) saturate(${saturation}) hue-rotate(${nightMode?"180deg":"0deg"}) invert(${nightMode?"1":"0"})`;return!0===sharpen&&"0"!==sharpness&&(f+=" url(#sharpen)"),f}adjustFilter(page){this.touchDevice||$(".pdfviewer-right img").slice(Math.max(page-3,0),page+3).css("filter",this.compileCss(!0))}adjustSharpness(page){if(this.touchDevice)return;let $svg=$("#sharpen feConvolveMatrix"),matrix=$svg.attr("kernelMatrix").split(" ");matrix[4]=-12*parseFloat($("#adjust-sharpness").val())+16,$svg.attr("kernelMatrix",matrix.join(" ")),this.adjustFilter(page)}disableSharpening(page){this.touchDevice||$(".pdfviewer-right img").slice(Math.max(page-3,0),page+3).css("filter",this.compileCss(!1))}reset(page){this.touchDevice||($("#adjust-contrast").val(this.default.contrast),$("#adjust-brightness").val(this.default.brightness),$("#adjust-saturation").val(this.default.saturation),$("#adjust-sharpness").val(this.default.sharpness),this.adjustSharpness(page))}lightMode(){$(".pdfviewer-left img").css("filter","hue-rotate(0deg) invert(0)"),$(".pdfviewer-right img").css("filter",this.compileCss(!0))}nightMode(){$(".pdfviewer-left img").css("filter","hue-rotate(180deg) invert(1)"),$(".pdfviewer-right img").css("filter",this.compileCss(!0))}}let imageFilter=new ImageFilter,arxiv={url:"https://export.arxiv.org/api/query?start=0&max_results=1&id_list=",metadata:function(input){let output={author_last_name:[],author_first_name:[],keywords:[],uid_types:[],uids:[],secondary_title:"eprint"},entry=input.find("entry");output.reference_type="article",output.title=entry.children("title").text().replace(/\r?\n|\r/g," ")||"",output.abstract=entry.children("summary").text().replace(/\r?\n|\r/g," ")||"";let d=new Date(entry.children("published").text().replace(/\r?\n|\r/g," "));output.publication_date=d.toISOString().substr(0,10);let doi=entry.children("arxiv\\:doi").text().replace(/\r?\n|\r/g," ")||"";if(""!==doi&&(output.uid_types.push("DOI"),output.uids.push(doi)),1===entry.find("id").length){output.uid_types.push("ARXIV");let arxivId=entry.find("id").text().replace(/https?:\/\/arxiv\.org\/abs\//,"");output.uids.push(arxivId),$(".uploadable-url").val("https://arxiv.org/pdf/"+arxivId)}return _.forEach(entry.find("name"),(function(author,key){let parts=$(author).text().split(" ");output.author_last_name[key]=parts.pop(),output.author_first_name[key]=parts.join(" ")})),_.forEach(entry.children("category"),(function(category,key){output.keywords[key]=$(category).attr("term")})),JSON.stringify(output)}},views={};B.emulateJSON=!0;let Router=B.Router.extend({routes:{":controller(/:action)(?:query)":"dispatch"},dispatch:function(uriController,uriAction,uriQuery){let c="string"==typeof uriController?uriController:"main",a="string"==typeof uriAction?uriAction:"main",q="string"==typeof uriQuery?"?"+uriQuery:"";$.when(model.load({url:window.IL_BASE_URL+"index.php/"+c+"/"+a+q})).done((function(response){"object"==typeof views[c+a]?views[c+a].render(response):console.error('The view "'+(c+a)+'" does not exist.')}))}}),router=new Router;class Model{constructor(){this.xhr="",this.options={url:null,data:void 0,async:!1,cors:!1,dataType:"json"}}load(options){return options=_.assign({},this.options,options),this._request("GET",options.url,options.data,options.async,options.cors,options.dataType)}save(options){return options=_.assign({},this.options,options),this._request("POST",options.url,options.data,options.async,options.cors,options.dataType)}_request(method,url,data,async,cors,dataType){let This=this,Dfrd=$.Deferred(),block=!0!==async,dataType2=dataType||"json";!0===block&&"object"==typeof this.xhr&&this.abort();let customHeader={"X-Client-Width":screen.width};!0===cors&&(customHeader={});let xhrObj=$.ajax({url:url,data:data,type:method,dataType:dataType2,headers:customHeader}).done((function(response){This._onSuccess(response),Dfrd.resolve(response)})).fail((function(xhr){This._onFail(xhr,cors),Dfrd.reject(xhr)}));return!0===block&&(overlay.start(),model.xhr=xhrObj),Dfrd}abort(){"object"==typeof this.xhr&&(this.xhr.abort(),this.xhr="",overlay.stop())}_onSuccess(response){this.xhr="",overlay.stop(),"string"==typeof response.info&&$.jGrowl(response.info,{header:"Info",sticky:!1,theme:"bg-primary"})}_onFail(xhr,cors){if(this.xhr="",overlay.stop(),!1===cors||void 0===cors)if("abort"===xhr.statusText);else if(401===xhr.status){let redir=window.IL_BASE_URL+"?ref="+window.btoa(location.href);location.replace(redir)}else if(404===xhr.status)location.replace(window.IL_BASE_URL+"index.php/notfound/main");else if(xhr.status>400&&xhr.status<500){let errMessage=void 0!==xhr.responseJSON?xhr.responseJSON.error:"Unspecified error.";$.jGrowl(errMessage,{header:"Info",sticky:!1,theme:"bg-primary"})}else{let errMessage=void 0!==xhr.responseJSON?xhr.responseJSON.error:"Unspecified error.";$.jGrowl(errMessage,{header:xhr.status+" "+xhr.statusText,sticky:!0,theme:"bg-danger"})}}}let model=new Model;class View{constuctor(){this.events={},this.parent=""}render(data){let $par=$(this.parent);return 1!==$par.length?(console.error('The view container "'+this.parent+'" not found!'),!1):("string"==typeof data.title&&(document.title=data.title),"string"==typeof data.html&&($par.html(data.html),this.delegateEvents(),"function"==typeof window.MathJax.typeset&&window.MathJax.typeset(),this.afterRender(data)),$(".modal").modal("hide"),$(".modal-backdrop").remove(),$('[data-toggle="tooltip"], .tooltip').tooltip("hide"),this)}htmlRender(){for(let key in this.events){let method=this.events[key];_.isFunction(method)||(method=this[method]);let match=key.match(/^(\S+)\s*(.*)$/);$("body").on(match[1]+".view",match[2],{object:this},method)}formStyle.init(),"function"==typeof window.MathJax.typeset&&window.MathJax.typeset(),this.afterRender()}afterRender(data=undefined){}delegateEvents(){if(void 0===this.events)return this;this.undelegateEvents();for(let key in this.events){let method=this.events[key];_.isFunction(method)||(method=this[method]);let match=key.match(/^(\S+)\s*(.*)$/);$(this.parent).on(match[1]+".view",match[2],{object:this},method)}return this}undelegateEvents(){return 1===$(this.parent).length&&$(this.parent).off(".view"),this}}class DashboardMainView extends View{constructor(){super(),this.parent="#content-col"}afterRender(data){formStyle.init(),quicksearch.init(),advancedsearch.init(),sessionStore.delete("il.idList")}}views.dashboardmain=new DashboardMainView;class SettingsMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #user-settings-form":"saveForm"}}afterRender(data){formStyle.init(),$("#timezones").typeahead(),$("#modal-settings").find(".modal-body").html("")}saveForm(e){e.preventDefault();let $f=$(this);$f.find(":checkbox").each((function(){!1===$(this).prop("checked")&&$f.append(`<input type="hidden" name="${$(this).attr("name")}" value="0">`)})),$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(){location.reload()}))}}views.settingsmain=new SettingsMainView;class ProfileMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #user-profile-form":"saveProfile","submit #user-profile-change-password":"savePassword"}}afterRender(data){$('[data-toggle="tooltip"]').tooltip({container:"#content-col"})}saveProfile(e){e.preventDefault();let $f=$(this);$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(){let fname=""===$("#first_name").val()?$("#username").val():$("#first_name").val();$("#menu-first-name").text(fname)}))}savePassword(e){e.preventDefault();let $f=$(this);$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(){$f[0].reset()}))}}views.profilemain=new ProfileMainView;class ItemsMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"click .open-filter-local":"filterLocal","click .open-filter-remote":"filterRemote","click .clipboard":"clipboard","click .project":"project","click #open-export":exportform.init,"click #open-omnitool":omnitoolform.init}}afterRender(data){formStyle.init();let This=this;this.itemsHeight(),$(window).off("resize.ItemsMainView").on("resize.ItemsMainView",(function(){This.itemsHeight()})),quicksearch.init(),advancedsearch.init(),sessionStore.save("il.idList",data.id_list),this.highlightSearch()}itemsHeight(){let bH=$("#bottom-row").outerHeight();$(".navbar-toggler").is(":visible")?$("#top-row").height($(window).height()-bH-$(".navbar-toggler").outerHeight(!0)-(1===$("#filter-list").length?$("#filter-list").outerHeight(!0):0)):$("#top-row").height($(window).height()-bH)}filterLocal(){let src=$(this).data("src"),ttl=$(this).data("title");$.when(model.load({url:src})).done((function(response){$("#modal-filters .modal-title").html(ttl),$("#modal-filters .modal-body .container-fluid").replaceWith(response.html),$("#modal-filters").modal(),$("#modal-filters .modal-body").on("click","a",(function(){$("#modal-filters").modal("hide")})),$("#modal-filters .filterable").filterable("destroy"),$("#modal-filters :text").filterable({targets:"#modal-filters a"}).val("").focus()}))}filterRemote(){let src=$(this).data("src"),ttl=$(this).data("title");$.when(model.load({url:src})).done((function(response){$("#modal-filters .modal-title").html(ttl),$("#modal-filters .modal-body .container-fluid").replaceWith(response.html),$("#modal-filters").modal(),$("#modal-filters .modal-body").on("click","a",(function(){$("#modal-filters").modal("hide")})),$("#modal-filters .filterable").filterable("destroy"),$("#modal-filters :text").filterable({source:src,container:"#modal-filters .container-fluid"}).val("").focus()}))}clipboard(){let $t=$(this),itemId=$t.closest(".item-container").data("id"),action=!0===$t.prop("checked")?"add":"delete";$.when(model.save({url:window.IL_BASE_URL+"index.php/clipboard/"+action,data:{id:itemId}})).fail((function(){$t.prop("checked",!$t.prop("checked")),formStyle.changeState($t)})).done((function(response){!0===response.max_count&&($t.prop("checked",!$t.prop("checked")),formStyle.changeState($t))}))}project(){let $t=$(this),itemId=$t.closest(".item-container").data("id"),projId=$t.val(),action=!0===$t.prop("checked")?"additem":"deleteitem";$.when(model.save({url:window.IL_BASE_URL+"index.php/project/"+action,data:{id:itemId,project_id:projId}})).fail((function(){$t.prop("checked",!$t.prop("checked")),formStyle.changeState($t)})).done((function(response){!0===response.max_count&&($t.prop("checked",!$t.prop("checked")),formStyle.changeState($t))}))}highlightSearch(){if(location.hash.indexOf("search_query")>-1&&$(".item-container").length>0){let uri=new URL("http://foo.bar/"+location.hash.substr(1));document.designMode="on";var sel=window.getSelection();for(let p of uri.searchParams)if(0===p[0].indexOf("search_query")){let terms=p[1].split(" ");for(let t of terms)if(sel.collapse(document.getElementsByClassName("item-container")[0],0),t=t.replace("*","").replace("%2A",""),t.length>1)for(;window.find(t,!1);)document.execCommand("hiliteColor",!1,"#ffff9bbf"),document.execCommand("foreColor",!1,"#222426")}sel.collapseToEnd(),document.designMode="off",sel.removeAllRanges(),$("#top-row").scrollTop(0)}}}views.itemsmain=new ItemsMainView,views.itemsfilter=new ItemsMainView;class ItemsCatalogView extends View{constructor(){super(),this.parent="#content-col",this.events={"click .open-filter-local":views.itemsmain.filterLocal,"click .open-filter-remote":views.itemsmain.filterRemote,"click .clipboard":"clipboard","click .project":"project","click #open-export":exportform.init,"click #open-omnitool":omnitoolform.init}}afterRender(data){views.itemsmain.afterRender(data)}clipboard(){let $t=$(this),itemId=$t.closest(".item-container").data("id"),action=!0===$t.prop("checked")?"add":"delete";$.when(model.save({url:window.IL_BASE_URL+"index.php/clipboard/"+action,data:{id:itemId}})).fail((function(){$t.prop("checked",!$t.prop("checked")),formStyle.changeState($t)})).done((function(response){!0===response.max_count&&($t.prop("checked",!$t.prop("checked")),formStyle.changeState($t))}))}project(){let $t=$(this),itemId=$t.closest(".item-container").data("id"),projId=$t.val(),action=!0===$t.prop("checked")?"additem":"deleteitem";$.when(model.save({url:window.IL_BASE_URL+"index.php/project/"+action,data:{id:itemId,project_id:projId}})).fail((function(){$t.prop("checked",!$t.prop("checked")),formStyle.changeState($t)})).done((function(response){!0===response.max_count&&($t.prop("checked",!$t.prop("checked")),formStyle.changeState($t))}))}}views.itemscatalog=new ItemsCatalogView;class ClipboardMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"click .open-filter-local":views.itemsmain.filterLocal,"click .open-filter-remote":views.itemsmain.filterRemote,"click .clipboard":"clipboard","click .project":"project","click #open-export":exportform.init,"click #open-omnitool":omnitoolform.init}}afterRender(data){views.itemsmain.afterRender(data)}clipboard(){let $t=$(this),itemId=$t.closest(".item-container").data("id"),action=!0===$t.prop("checked")?"add":"delete";$.when(model.save({url:window.IL_BASE_URL+"index.php/clipboard/"+action,data:{id:itemId}})).done((function(){B.history.loadUrl()})).fail((function(){$t.prop("checked",!$t.prop("checked")),formStyle.changeState($t)}))}project(){let $t=$(this),itemId=$t.closest(".item-container").data("id"),projId=$t.val(),action=!0===$t.prop("checked")?"additem":"deleteitem";$.when(model.save({url:window.IL_BASE_URL+"index.php/project/"+action,data:{id:itemId,project_id:projId}})).fail((function(){$t.prop("checked",!$t.prop("checked")),formStyle.changeState($t)})).done((function(response){!0===response.max_count&&($t.prop("checked",!$t.prop("checked")),formStyle.changeState($t))}))}}views.clipboardmain=new ClipboardMainView,views.clipboardfilter=new ClipboardMainView;class ProjectsMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #project-form":"submitForm","click .join":"joinProject","click .leave":"leaveProject","click .activate":"activateProject","click .inactivate":"inactivateProject"}}afterRender(data){formStyle.init(),$('[data-toggle="tooltip"]').tooltip(),$(".delete").confirmable({submit:function(){$.when(model.save({url:window.IL_BASE_URL+"index.php/project/delete",data:{project_id:$(this).data("projectId")}})).done((function(){B.history.loadUrl()}))}}),$("#filter-active").filterable({targets:".active-project",complete:function(){$(".active-project-container").removeClass("d-none"),$(".active-project.d-none").closest(".active-project-container").addClass("d-none")}}),$("#filter-open").filterable({targets:".open-project",complete:function(){$(".open-project-container").removeClass("d-none"),$(".open-project.d-none").closest(".open-project-container").addClass("d-none")}}),$("#filter-inactive").filterable({targets:".inactive-project",complete:function(){$(".inactive-project-container").removeClass("d-none"),$(".inactive-project.d-none").closest(".inactive-project-container").addClass("d-none")}})}submitForm(e){let This=e.data.object;e.preventDefault(),$.when(model.save({url:$(this).attr("action"),data:$(this).serialize()})).done((function(response){$("#content-col").html(response.html),This.afterRender()}))}joinProject(){$.when(model.save({url:window.IL_BASE_URL+"index.php/project/join",data:{project_id:$(this).data("projectId")}})).done((function(){B.history.loadUrl()}))}leaveProject(){$.when(model.save({url:window.IL_BASE_URL+"index.php/project/leave",data:{project_id:$(this).data("projectId")}})).done((function(){B.history.loadUrl()}))}activateProject(){$.when(model.save({url:window.IL_BASE_URL+"index.php/project/activate",data:{project_id:$(this).data("projectId")}})).done((function(){B.history.loadUrl()}))}inactivateProject(){$.when(model.save({url:window.IL_BASE_URL+"index.php/project/inactivate",data:{project_id:$(this).data("projectId")}})).done((function(){B.history.loadUrl()}))}}views.projectsmain=new ProjectsMainView;class ProjectBrowseView extends View{constructor(){super(),this.parent="#content-col",this.events={"click .open-filter-local":views.itemsmain.filterLocal,"click .open-filter-remote":views.itemsmain.filterRemote,"click .clipboard":"clipboard","click .project":"project","click #open-export":exportform.init,"click #open-omnitool":omnitoolform.init}}afterRender(data){formStyle.init(),views.itemsmain.afterRender(data)}clipboard(){let $t=$(this),itemId=$t.closest(".item-container").data("id"),action=!0===$t.prop("checked")?"add":"delete";$.when(model.save({url:window.IL_BASE_URL+"index.php/clipboard/"+action,data:{id:itemId}})).fail((function(){$t.prop("checked",!$t.prop("checked")),formStyle.changeState($t)}))}project(){let $t=$(this),itemId=$t.closest(".item-container").data("id"),projId=$t.val(),action=!0===$t.prop("checked")?"additem":"deleteitem";$.when(model.save({url:window.IL_BASE_URL+"index.php/project/"+action,data:{id:itemId,project_id:projId}})).fail((function(){$t.prop("checked",!$t.prop("checked")),formStyle.changeState($t)})).done((function(response){!0===response.max_count&&($t.prop("checked",!$t.prop("checked")),formStyle.changeState($t)),B.history.loadUrl()}))}}views.projectbrowse=new ProjectBrowseView,views.projectfilter=new ProjectBrowseView;class ProjectEditView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #project-form":"submitForm"}}afterRender(data){formStyle.init(),$("#content-col").find('[data-toggle="tooltip"]').tooltip()}submitForm(e){e.preventDefault();let $t=$(this);$.when(model.save({url:$t.attr("action"),data:$t.serialize()})).done((function(){B.history.loadUrl()}))}}views.projectedit=new ProjectEditView;class ProjectDiscussionView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #message-form":"bindForm"}}afterRender(data){}bindForm(e){e.preventDefault();let $f=$(this);$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(){B.history.loadUrl()}))}}views.projectdiscussion=new ProjectDiscussionView;class ProjectNotesView extends View{constructor(){super(),this.parent="#content-col",this.events={}}afterRender(data){}}views.projectnotes=new ProjectNotesView,views.projectcompilenotes=new ProjectNotesView;class TagsManageView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit .edit-tag-form":"editTag","submit #tag-form":"createTag"}}editTag(e){e.preventDefault();let $f=$(this);$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(){B.history.loadUrl()}))}createTag(e){e.preventDefault();let $f=$(this);$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(){B.history.loadUrl()}))}}views.tagsmanage=new TagsManageView;class NormalizeMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"change #select-metadata":"changeSource","submit .edit-form":"submitForm"}}afterRender(data){let $in=$("#search-metadata");$in.filterable({source:$in.attr("data-source"),container:$in.attr("data-container")})}changeSource(e){e.data.object;let $in=$("#search-metadata"),src=window.IL_BASE_URL+"index.php/normalize/search"+$(this).val();$in.filterable("destroy"),$("#results").empty(),$in.attr("data-source",src).val(""),$in.filterable({source:$in.attr("data-source"),container:$in.attr("data-container")})}submitForm(e){e.preventDefault();let $f=$(this);$.when(model.save({url:$f.attr("action"),data:$f.serialize()}))}}views.normalizemain=new NormalizeMainView;class NormalizeResultsView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit .edit-form":"submitForm"}}submitForm(e){e.preventDefault();let $f=$(this);$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(){B.history.loadUrl()}))}}views.normalizeauthors=new NormalizeResultsView,views.normalizeeditors=new NormalizeResultsView,views.normalizeprimary=new NormalizeResultsView,views.normalizesecondary=new NormalizeResultsView,views.normalizetertiary=new NormalizeResultsView;class DuplicatesMainView extends View{constructor(){super(),this.parent="#content-col"}}views.duplicatesmain=new DuplicatesMainView;class DuplicatesFindView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit .merge-form":"merge"}}afterRender(data){formStyle.init()}merge(e){e.preventDefault();let $f=$(this);$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(){$f.closest(".card").remove()}))}}views.duplicatesfind=new DuplicatesFindView;class ReindexMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"click #reindex":"reindex","click #defragment":"defragment","click #check-fts":"integrityFts","click #check-db":"integrityDb","click #reextract":"reextract"}}integrityFts(){$.when(model.load({url:window.IL_BASE_URL+"index.php/reindex/checkfts"}))}integrityDb(){$.when(model.load({url:window.IL_BASE_URL+"index.php/reindex/checkdb"}))}defragment(){$.when(model.load({url:window.IL_BASE_URL+"index.php/reindex/defragment"})).done((function(){B.history.loadUrl()}))}reindex(){$.when(model.load({url:window.IL_BASE_URL+"index.php/reindex/reindex"})).done((function(){B.history.loadUrl()}))}reextract(){$.when(model.load({url:window.IL_BASE_URL+"index.php/reindex/reextract"})).done((function(){B.history.loadUrl()}))}}views.reindexmain=new ReindexMainView;class SummaryMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"click .clipboard":"clipboard","click .project":"project","click #open-export":exportform.init,"submit .form-uid":"submitForm","click .open-notes":"openNotes","click .rescan-pdf":"rescanPdf","click .update-key":"updateKey"}}afterRender(data){formStyle.init(),$(".truncate").expandable();let This=this;this.itemHeight(),$(window).off("resize.SummaryMainView").on("resize.SummaryMainView",(function(){This.itemHeight()})),"object"==typeof itemview&&(itemview.clickTitle(),itemview.changeTitleLink()),$("#delete-item").confirmable({submit:function(){$.when(model.save({url:window.IL_BASE_URL+"index.php/item/delete",data:{id:$("body").data("id")}})).done((function(){location.assign(window.IL_BASE_URL+"index.php#dashboard/main")}))}});let anId=new URL("http://foo.bar/"+location.hash.substring(1)).searchParams.get("id")||"";$("body").attr("data-id",anId).data("id",anId),$("a.add-id-link").each((function(){let thisHParts=$(this).attr("href").split("id=");$(this).attr("href",thisHParts[0]+"id="+anId)}));let itemList=sessionStore.load("il.idList");if(itemList){let prevItem=itemList[itemList.indexOf(itemList.find((o=>o.id===anId)))-1],nextItem=itemList[itemList.indexOf(itemList.find((o=>o.id===anId)))+1];void 0===prevItem?$("#summary-previous").addClass("disabled").attr("tabindex","-1").attr("aria-disabled","true"):$("#summary-previous").attr("href","#summary?id="+prevItem.id),void 0===nextItem?$("#summary-next").addClass("disabled").attr("tabindex","-1").attr("aria-disabled","true"):$("#summary-next").attr("href","#summary?id="+nextItem.id)}else $("#summary-next, #summary-previous").remove();$("#autoupload-doi-form").saveable()}itemHeight(){let bH=$("#bottom-row").outerHeight();$(".navbar-toggler").is(":visible")?$("#top-row").height($(window).height()-bH-$(".navbar-toggler").outerHeight(!0)):$("#top-row").height($(window).height()-bH)}clipboard(){let $t=$(this),itemId=$("body").data("id"),action=!0===$t.prop("checked")?"add":"delete";$.when(model.save({url:window.IL_BASE_URL+"index.php/clipboard/"+action,data:{id:itemId}})).fail((function(){$t.prop("checked",!$t.prop("checked")),formStyle.changeState($t)})).done((function(response){!0===response.max_count&&($t.prop("checked",!$t.prop("checked")),formStyle.changeState($t))}))}project(){let $t=$(this),itemId=$("body").data("id"),projId=$t.val(),action=!0===$t.prop("checked")?"additem":"deleteitem";$.when(model.save({url:window.IL_BASE_URL+"index.php/project/"+action,data:{id:itemId,project_id:projId}})).fail((function(){$t.prop("checked",!$t.prop("checked")),formStyle.changeState($t)})).done((function(response){!0===response.max_count&&($t.prop("checked",!$t.prop("checked")),formStyle.changeState($t))}))}submitForm(e){let $f=$(this);e.preventDefault(),$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(){B.history.loadUrl()})),$("#autoupload-doi-form").trigger("save")}openNotes(){null!==window.tinymce.activeEditor&&!0===window.tinymce.activeEditor.initialized?$("#notes-window").removeClass("d-none"):views.summarymain.loadNotes()}loadNotes(){let This=this,itemId=$("body").attr("data-id");$.when(model.load({url:window.IL_BASE_URL+"index.php/notes/user",data:{id:itemId}})).done((function(response){$("#notes-ta").val(response.user.note),$("#id-hidden").val(itemId),This.initNotes()}))}initNotes(){null===window.tinymce.activeEditor||!0!==window.tinymce.activeEditor.initialized?window.tinymce.init({theme:"silver",selector:"#notes-ta",content_css:window.IL_BASE_URL+"css/style.css",resize:"both",min_height:300,menubar:!1,plugins:"importcss save lists advlist link image code fullscreen table searchreplace",toolbar1:"save undo redo fullscreen code | formatselect link unlink image table searchreplace",toolbar2:"bold italic underline strikethrough subscript superscript removeformat | forecolor backcolor | outdent indent bullist numlist",save_onsavecallback:function(editor){let $f=$("#note-form");$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(){$("#user-note").html(editor.getContent()),"function"==typeof window.MathJax.typeset&&window.MathJax.typeset()}))},image_description:!1,relative_urls:!1,remove_script_host:!1,image_dimensions:!1,image_class_list:[{title:"Auto width",value:"mce-img-fluid"}],image_list:window.IL_BASE_URL+"index.php/supplements/imagelist?as=json&id="+$("body").data("id")}).then((function(){let $nw=$("#notes-window");$nw.removeClass("d-none"),$nw.position({my:"left bottom",at:"left bottom",of:"#content-col"}),$(window).off("resize.notes").on("resize.notes",(function(){$nw.position({my:"left bottom",at:"left bottom",of:"#content-col"})})),$nw.draggable({handle:".card-header",containment:"body"}),$nw.find(".close").off("click.notes").on("click.notes",(function(){$("#notes-window").addClass("d-none")}))})):window.tinymce.activeEditor.load()}rescanPdf(){let link=$(this).data("url");$.when(model.load({url:link})).done((function(){B.history.loadUrl()}))}updateKey(){$.when(model.save({url:$(this).data("url"),data:{id:$(this).data("id")}})).done((function(){B.history.loadUrl()}))}}views.summarymain=new SummaryMainView;class NotesMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"click .open-notes":views.summarymain.openNotes}}afterRender(){let anId=new URL("http://foo.bar/"+location.hash.substring(1)).searchParams.get("id")||"";$("body").attr("data-id",anId).data("id",anId),"object"==typeof itemview&&(itemview.clickTitle(),itemview.changeTitleLink())}}views.notesmain=new NotesMainView;class EditMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #edit-form":"bindForm","change #reference-type":"bindReferenceType"}}afterRender(data){this.uploadFormWidgets(),"object"==typeof itemview&&(itemview.clickTitle(),itemview.changeTitleLink())}bindForm(e){e.preventDefault();let $f=$(this);$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(){B.history.loadUrl()}))}bindReferenceType(){$("#edit-form").trigger("submit")}uploadFormWidgets(){let This=this;$("input.input-typeahead").each((function(){let $t=$(this);$t.typeahead({source:$t.data("source"),onSelect:function(){This._selectAuthor(this)}})})),$("#clone-authors").clonable({target:"#new-author-container",onClone:function(e,data){let $last=$(data.clonedTarget).find(".input-typeahead");$last.typeahead({source:$last.data("source"),onSelect:function(){This._selectAuthor(this)}})}}),$("#clone-editors").clonable({target:"#new-editor-container",onClone:function(e,data){let $last=$(data.clonedTarget).find(".input-typeahead");$last.typeahead({source:$last.data("source"),onSelect:function(){This._selectAuthor(this)}})}}),$("#clone-uid").clonable({target:"#uid-row"})}_selectAuthor(typeahead){if($(typeahead).is("[name^='author_last_name']")){let $first=$(typeahead).closest(".form-row").find('input[name^="author_first_name"]'),names=$(typeahead).val().split(",");$(typeahead).val($.trim(names[0]||"")),$first.val($.trim(names[1]||""))}if($(typeahead).is("[name^='editor_last_name']")){let $first=$(typeahead).closest(".form-row").find('input[name^="editor_first_name"]'),names=$(typeahead).val().split(",");$(typeahead).val($.trim(names[0]||"")),$first.val($.trim(names[1]||""))}}}views.editmain=new EditMainView;class ItemdiscussionMainView extends View{constructor(){super(),this.parent="#content-col",this.messagesId="",this.events={"submit #message-form":"bindForm"}}afterRender(data){this.messagesId=setInterval(this.refreshMessages,1e4),"object"==typeof itemview&&(itemview.clickTitle(),itemview.changeTitleLink())}bindForm(e){e.preventDefault();let This=e.data.object,$f=$(this);$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(){This.refreshMessages(),$f.get(0).reset()}))}refreshMessages(){if(0===$("#message-list").length)return void clearInterval(this.messagesId);let itemId=$("body").data("id");$.when(model.load({url:window.IL_BASE_URL+"index.php/itemdiscussion/messages?id="+itemId})).done((function(response){$("#message-list").html(response.html),$("#message").val("")}))}}views.itemdiscussionmain=new ItemdiscussionMainView;class TagsItemView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #tag-form":"createTags","change .tag-inputs":"changeTags"}}afterRender(data){formStyle.init(),$("#tag-filter").filterable({complete:function(){$("#content-col .label-text").each((function(){$(this).hasClass("d-none")?$(this).parent().parent().addClass("d-none"):$(this).parent().parent().removeClass("d-none")})),$(".tag-table").find("tr").each((function(){$(this).find(".label-text").length-$(this).find(".label-text.d-none").length==0?$(this).addClass("d-none"):$(this).removeClass("d-none")}))}}),"object"==typeof itemview&&(itemview.clickTitle(),itemview.changeTitleLink())}createTags(e){e.preventDefault();let This=e.data.object,$f=$(this);""!==$("#new_tags").val()&&$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(response){$("#content-col").html(response.html),This.afterRender()}))}changeTags(){let $t=$(this),itemId=$("body").data("id");$t.is(":checked")?$.when(model.save({url:window.IL_BASE_URL+"index.php/tags/additem",data:{id:itemId,tag_id:$t.val()}})).fail((function(){$t.prop("checked",!1),formStyle.updateStyle($t)})):$.when(model.save({url:window.IL_BASE_URL+"index.php/tags/deleteitem",data:{id:itemId,tag_id:$t.val()}})).fail((function(){$t.prop("checked",!0),formStyle.updateStyle($t)}))}}views.tagsitem=new TagsItemView;class SupplementsMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"click .rename-file":"renameFile","keydown input.form-control":"submitInput"}}afterRender(data){formStyle.init(),$("#upload-form").uploadable({maxFiles:64}),$(".delete-file").confirmable({submit:function(){let file=$(this).closest("li").find(".filename-link").text().trim(),itemId=$("body").data("id");$.when(model.save({url:window.IL_BASE_URL+"index.php/supplements/delete",data:{id:itemId,filename:file}})).done((function(){B.history.loadUrl()}))}}),"object"==typeof itemview&&(itemview.clickTitle(),itemview.changeTitleLink())}renameFile(){let $l=$(this).closest("li").find(".filename-link"),$i=$(this).closest("li").find("input");if($l.hasClass("d-none")){let filename=$.trim($l.text()),newname=$.trim($i.val());$.when(model.save({url:window.IL_BASE_URL+"index.php/supplements/rename",data:{id:$("body").data("id"),filename:filename,newname:newname}})).done((function(){B.history.loadUrl()}))}else $l.addClass("d-none"),$i.removeClass("d-none").addClass("d-inline-block").val($.trim($l.text())).focus()}submitInput(e){13===e.which&&$(this).closest(".list-group-item").find(".rename-file").trigger("click")}}views.supplementsmain=new SupplementsMainView;class PdfMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"change #pdfviewer-zoom":"selectZoom","input #pdfviewer-page-input":"inputPageNum","click #pdfviewer-first":"buttonPageNum","click #pdfviewer-prev":"buttonPageNum","click #pdfviewer-next":"buttonPageNum","click #pdfviewer-last":"buttonPageNum","click .pdfviewer-thumb":"thumbPageNum","click #pdfviewer-image":"toggleCropper","click #copy-image-btn":"getCroppedImage","click #save-image-btn":"saveCroppedImage","click #pdfviewer-left-btn":"toggleLeft","click #pdfviewer-previews-btn":"showThumbs","click #pdfviewer-bookmarks-btn":"showBookmarks","click #pdfviewer-results-btn":"showResults","click #pdfviewer-bookmarks a":"clickBookmark","click #pdfviewer-night-btn":"nightMode","click #pdfviewer-text-btn":"toggleTextLayer","click .highlight-color":"addHighlights","click .highlight-eraser":"eraserInit","click #pdfviewer-annot-menu .annot-show":"showAnnotations","click #pdfviewer-annot-menu .annot-hide":"hideAnnotations","click .highlight-cancel":"clearHighlights","dblclick .pdfviewer-page":"dblZoom","keyup #pdfviewer-search-input":"search","click #pdfviewer-results > .pdfviewer-results-container > a":"scrollToResult","click #pdfviewer-result-up":"prevResult","click #pdfviewer-result-down":"nextResult","click #pdfviewer-notes-btn":"showNotes","click .note-edit-btn":"editNote","submit .note-form":"saveNote","submit #new-note-form":"saveNote","click #pdfviewer-new-note-btn":"createNewNote","click .pdflink":"openLink","change #pdfviewer-underlined":"highlightStyle"}}afterRender(data){this.selectable=void 0,this.page=void 0,this.sseSearch=void 0;let This=this;if(this.throttledZoom=_.throttle((function(zoom){This.pageZoom(zoom)}),500,{leading:!0,trailing:!0}),"object"==typeof itemview&&(itemview.clickTitle(),itemview.changeTitleLink()),0===$("#pdfviewer-pages").length)return;"underlined"===store.load("il.highlightStyle")&&$("#pdfviewer-underlined").prop("checked",!0),formStyle.init(),$("#content-col").find('[data-toggle="tooltip"]').tooltip();let anId=new URL(location.href).searchParams.get("id")||"";""!==anId&&$("body").attr("data-id",anId).data("id",anId),$(window).off("resize.PdfMainView").on("resize.PdfMainView",(function(){This.pagesHeight(),This.pageZoom(store.load("il.pageZoom")||"auto"),$(".pdfviewer-right").trigger("scroll")})),this.pagesHeight(),new LazyLoad({container:$("#pdfviewer-pages .pdfviewer-left").get(0),elements_selector:".lazy",load_delay:250,threshold:400,callback_loaded:el=>{el.style.width="200px",el.style.height=Math.round(200/el.naturalWidth*el.naturalHeight)+"px"}}),this.lazyLoad=new LazyLoad({container:document.querySelector(".pdfviewer-right"),elements_selector:".lazy",load_delay:250,threshold:1e3,callback_loaded:el=>{let ratio=1,zoom=store.load("il.pageZoom");if("auto"===zoom){let pageWidth=$(".pdfviewer-right").width()-30,imgWidth=$(".pdfviewer-page > img").eq(0).attr("width"),tempZoom=Math.max(100*pageWidth/imgWidth,50);[50,75,100,125,150,200,250,300].forEach((function(v){v<=tempZoom&&(zoom=v.toString())}))}zoom<200&&(ratio=.5),zoom<100&&(ratio=.25),el.style.width=Math.round(ratio*el.naturalWidth)+"px",el.style.height=Math.round(ratio*el.naturalHeight)+"px"}}),!0===store.load("il.nightMode")&&$("#pdfviewer-night-btn").click(),!0===store.load("il.leftPanel")&&(this.showLeft(),this.showThumbs()),this.pageZoom(store.load("il.pageZoom")||"auto"),$("#adjust-sharpness").val(imageFilter.default.sharpness),$(".pdfviewer-right").off("scroll").on("scroll",_.throttle((function(){This.redrawNoteLine(),This.redrawSnippetLine(),imageFilter.disableSharpening(This.page),clearTimeout($.data(window,"scrollTimer")),$.data(window,"scrollTimer",setTimeout((function(){$(".pdfviewer-right > div").each((function(){return!This.detectVisiblePage(this,this.getBoundingClientRect(),$(".pdfviewer-right")[0].getBoundingClientRect())})),"object"==typeof This.selectable&&This.selectable.refresh(),imageFilter.adjustSharpness(This.page)}),200))}),20)),$(".pdfviewer-left").off("scroll").on("scroll",_.throttle((function(){This.redrawNoteLine(),This.redrawSnippetLine()}),20)),"object"==typeof This.selectable&&(This.selectable.disable(),This.selectable.destroy()),"object"==typeof This.cropper&&This.destroyCropper();let params={},e=$.Event("keyup");params=location.hash.length>1?new URL("http://foo.bar/"+location.hash.substring(1)).searchParams:new URL(location.href).searchParams,null!==params.get("search")&&(e.which=13,$("#pdfviewer-search-input").val(params.get("search")).trigger(e));let initialPage=params.get("page")||$("#pdfviewer-page-input").val();this.setPageNumber(initialPage),this.scrollToPage(initialPage,0),this.getLinks()}selectZoom(e){e.data.object.throttledZoom($(this).val())}dblZoom(e){let zoom=store.load("il.pageZoom");if("auto"===zoom){let tempZoom=100*($(".pdfviewer-right").width()-30)/(.5*$(".pdfviewer-page > img").eq(0).attr("width"));[50,75,100,125,150,200,250,300].forEach((function(v){v<=tempZoom&&(zoom=v.toString())}))}else zoom="auto";e.data.object.pageZoom(zoom)}pageZoom(zoom){"screen"===zoom&&(zoom="auto");let imgZoom,pageBefore=this.page;if($("#pdfviewer-zoom").val(zoom),store.save("il.pageZoom",zoom),"auto"===zoom){let pageWidth=$(".pdfviewer-right").width()-30,imgWidth=$(".pdfviewer-page > img").eq(0).attr("width"),tempZoom=Math.max(100*pageWidth/imgWidth,50);[50,75,100,125,150,200,250,300].forEach((function(v){v<=tempZoom&&(zoom=v.toString())}))}switch(zoom){case"50":case"100":case"200":default:imgZoom="200";break;case"125":case"250":imgZoom="250";break;case"75":case"150":case"300":imgZoom="300"}$(".pdfviewer-page > img").each((function(){this.style.width=Math.round(.01*zoom*this.getAttribute("width"))+"px",this.style.height=Math.round(.01*zoom*this.getAttribute("height"))+"px",null!==this.getAttribute("data-src")&&(this.removeAttribute("data-was-processed"),this.classList.remove("loaded"),this.setAttribute("data-src",this.getAttribute("data-src").replace(/zoom=\d+/,"zoom="+imgZoom)))})),this.lazyLoad.update(),this.scrollToPage(pageBefore,0)}pagesHeight(){let mH=$("#pdfviewer-menu").outerHeight();$(".navbar-toggler").is(":visible")?$("#pdfviewer-pages, .pdfviewer-left, .pdfviewer-right").height($(window).height()-mH-$(".navbar-toggler").outerHeight(!0)):$("#pdfviewer-pages, .pdfviewer-left, .pdfviewer-right").height($(window).height()-mH)}detectVisiblePage(el,elRect,rootRect){return(elRect.top-rootRect.top>0&&elRect.top-rootRect.top<rootRect.height/2||rootRect.bottom-elRect.bottom>0&&rootRect.bottom-elRect.bottom<rootRect.height/2||rootRect.top-elRect.top>0&&elRect.bottom-rootRect.bottom>0)&&(this.setPageNumber($(el).data("page")),!0)}setPageNumber(pgNum){let This=this;This.page!==parseInt(pgNum)&&(This.page=parseInt(pgNum),void 0!==this.pageTimer&&clearTimeout(this.pageTimer),this.pageTimer=_.delay((function(){$("#pdfviewer-page-input").val(pgNum),$(".pdfviewer-thumb").children("div").removeClass("bg-primary").addClass("bg-secondary"),$(".pdfviewer-thumb").eq(pgNum-1).children("div").removeClass("bg-secondary").addClass("bg-primary"),$("#pdfviewer-pages .pdfviewer-left").animate({scrollTop:$(".pdfviewer-thumb").eq(pgNum-1).position().top+$("#pdfviewer-pages .pdfviewer-left").scrollTop()-$(".pdfviewer-thumb").eq(pgNum-1).height()/2},100),$("#pdfviewer-pages").find(".pdfviewer-text").length>0&&This.getBoxes(pgNum),$("#pdfviewer-pages").find(".pdfviewer-highlights").length>0&&This.getHighlights(),model.load({url:window.IL_BASE_URL+"index.php/pdf/logpage",data:{id:$("body").data("id"),page:pgNum},async:!0})}),400))}buttonPageNum(e){let i,pgNum,speed=600;switch($(this).data("value")){case"first":pgNum=1;break;case"prev":for(pgNum=parseInt($("#pdfviewer-page-input").val()),i=pgNum;i>pgNum-10;i--){let elRect=$(".pdfviewer-page").eq(i-1)[0].getBoundingClientRect(),prevRect=$(".pdfviewer-page").eq(i-2)[0].getBoundingClientRect();if(elRect.top>prevRect.top){pgNum=i-1;break}}speed=200;break;case"next":for(pgNum=parseInt($("#pdfviewer-page-input").val()),i=pgNum;i<pgNum+10;i++){let elRect=$(".pdfviewer-page").eq(i-1)[0].getBoundingClientRect();if($(".pdfviewer-page").eq(i)[0].getBoundingClientRect().top>elRect.top){pgNum=i+1;break}}speed=200;break;case"last":pgNum=$(".pdfviewer-page").last().data("page")}e.data.object.scrollToPage(pgNum,speed)}inputPageNum(e){let This=e.data.object,pg=$(this).val();void 0!==This.t&&clearTimeout(This.t),This.t=_.delay((function(){This.scrollToPage(pg)}),300)}thumbPageNum(e){e.data.object.scrollToPage($(this).data("page"))}scrollToPage(pgNum,speed=undefined){let time=void 0===speed?400:speed;1===$('.pdfviewer-page[data-page="'+pgNum+'"]').length&&$(".pdfviewer-right").animate({scrollTop:$('.pdfviewer-page[data-page="'+pgNum+'"]').position().top+$(".pdfviewer-right").scrollTop()-12},time)}scrollToElement(el,speed){let time=void 0===speed?400:speed,$pr=$(".pdfviewer-right"),elTop=el.offset().top;(elTop<100||elTop>$(window).height()-100)&&$pr.animate({scrollTop:elTop+$pr.scrollTop()-$(window).height()/2},{duration:time,queue:!1});let elRect=el[0].getBoundingClientRect(),contRect=$pr[0].getBoundingClientRect();(elRect.left<contRect.left||elRect.right>contRect.right)&&$pr.animate({scrollLeft:$pr.scrollLeft()+elRect.left-contRect.left-.5*$pr.width()},{duration:time,queue:!1})}toggleCropper(e){if(void 0===e.data.object.cropper){e.data.object.clearHighlights(e),e.data.object.clearNotes(e),e.data.object.pageZoom("auto"),e.data.object.destroyTextLayer(),$(".dropdown.show .dropdown-toggle").dropdown("toggle"),$("#pdfviewer-menu").find("button, input, select").prop("disabled",!0),$(".btn-group-toggle").addClass("disabled").children().addClass("disabled"),$("#pdfviewer-image").prop("disabled",!1);let imageIndex=e.data.object.page-1;e.data.object.cropper=new Cropper($(".pdfviewer-page > img")[imageIndex],{background:!1,viewMode:1,dragMode:"move",initialAspectRatio:1,rotatable:!1,movable:!1,zoomable:!1,autoCropArea:.5,ready:function(){let btn1=$("#copy-image-btn-temp").clone(),btn2=$("#save-image-btn-temp").clone();$(".cropper-crop-box").append('<div id="crop-buttons" style="position: absolute;bottom:-3rem;white-space: nowrap"></div>'),btn1.attr("id","copy-image-btn").removeClass("d-none").appendTo("#crop-buttons"),btn2.attr("id","save-image-btn").removeClass("d-none").appendTo("#crop-buttons")}}),$("#pdfviewer-pages > .pdfviewer-right > .pdfviewer-page:first").hasClass("img-night-mode")&&e.data.object.nightMode()}else e.data.object.destroyCropper()}destroyCropper(){$("#pdfviewer-menu").find("button, input, select").prop("disabled",!1),$(".btn-group-toggle").removeClass("disabled").children().removeClass("disabled"),"object"==typeof this.cropper&&(this.cropper.destroy(),this.cropper=void 0)}getCroppedImage(e){let This=e.data.object,data=This.cropper.getData(!0),img=new URL(This.cropper.url);_.assign(data,{id:$("body").data("id"),page:This.page,zoom:img.searchParams.get("zoom")}),location.assign(window.IL_BASE_URL+"index.php/page/loadcrop?"+$.param(data))}saveCroppedImage(e){let This=e.data.object,data=This.cropper.getData(!0),img=new URL(This.cropper.url);_.assign(data,{id:$("body").data("id"),page:This.page,zoom:img.searchParams.get("zoom")}),model.save({url:window.IL_BASE_URL+"index.php/page/savecrop",data:$.param(data)})}toggleLeft(e){let This="object"==typeof e?e.data.object:this;$(".pdfviewer-left").hasClass("d-none")?This.showLeft():This.hideLeft()}showLeft(){$(".pdfviewer-left").removeClass("d-none"),$(window).trigger("resize.PdfMainView"),store.save("il.leftPanel",$(".pdfviewer-left").is(":visible")),!0===$("#pdfviewer-thumbs").hasClass("d-none")&&!0===$("#pdfviewer-bookmarks").hasClass("d-none")&&!0===$("#pdfviewer-notes").hasClass("d-none")&&!0===$("#pdfviewer-results").hasClass("d-none")&&this.showThumbs()}hideLeft(){$(".pdfviewer-left").addClass("d-none"),$(window).trigger("resize.PdfMainView"),store.save("il.leftPanel",$(".pdfviewer-left").is(":visible"))}showThumbs(e){let This="object"==typeof e?e.data.object:this;$("#pdfviewer-thumbs").removeClass("d-none"),$("#pdfviewer-bookmarks").addClass("d-none"),$("#pdfviewer-notes").addClass("d-none"),$("#pdfviewer-results").addClass("d-none"),This.redrawNoteLine(),This.redrawSnippetLine();$(".pdfviewer-thumb > img").each((function(){"200px"!==this.style.width&&(this.style.width="200px",this.style.height=200/this.getAttribute("width")*this.getAttribute("height")+"px")}))}showBookmarks(e){let This="object"==typeof e?e.data.object:this;if(1===$("#pdfviewer-bookmarks :text").length)return $("#pdfviewer-thumbs").addClass("d-none"),$("#pdfviewer-bookmarks").removeClass("d-none"),$("#pdfviewer-notes").addClass("d-none"),$("#pdfviewer-results").addClass("d-none"),This.redrawNoteLine(),This.redrawSnippetLine(),!1;$.when(model.load({url:window.IL_BASE_URL+"index.php/pdf/bookmarks?id="+$("body").data("id")})).done((function(response){$("#pdfviewer-thumbs").addClass("d-none"),$("#pdfviewer-notes").addClass("d-none"),$("#pdfviewer-results").addClass("d-none"),$("#pdfviewer-bookmarks").removeClass("d-none").html(response.html),$("#pdfviewer-bookmarks :text").filterable({targets:"#pdfviewer-bookmarks a"}).val(""),This.redrawNoteLine(),This.redrawSnippetLine()}))}clickBookmark(e){e.preventDefault(),e.data.object.scrollToPage($(this).data("page"))}nightMode(){$("#pdfviewer-pages > .pdfviewer-right > .pdfviewer-page").toggleClass("img-night-mode img-light-mode");let nightMode=$("#pdfviewer-pages > .pdfviewer-right > .pdfviewer-page:first").hasClass("img-night-mode");nightMode?imageFilter.nightMode():imageFilter.lightMode(),store.save("il.nightMode",nightMode)}toggleTextLayer(e){let This=e.data.object,pgNum=This.page;0===$("#pdfviewer-pages").find(".pdfviewer-text").length?(This.clearHighlights(e),This.clearNotes(e),void 0===This.selectable&&(This.selectable=new Selectable({lasso:{backgroundColor:"transparent"},lassoSelect:"sequential",appendTo:"#pdfviewer-pages",maxSelectable:1e3})),This.selectable.off("end"),This.selectable.on("end",This.copyText),This.getBoxes(pgNum)):This.destroyTextLayer()}destroyTextLayer(){$("#pdfviewer-pages").find(".pdfviewer-text").remove(),"object"==typeof this.selectable&&(this.selectable.off("end",this.copyText),this.selectable.disable(),this.selectable.destroy(),this.selectable=void 0)}copyText(){let txt="";if($(".pdfviewer-text").children(".ui-selected").each((function(){txt=txt+$(this).attr("data-text")+" "})),txt=txt.replace(/(- )/g,""),txt=txt.replace(/\s{2,}/g," "),txt=$.trim(txt),""===txt)return!1;$('<textarea id="copy-text-container" style="position: fixed;left: -1000px">'+txt+"</textarea>").appendTo("body"),$("#copy-text-container").select();try{document.execCommand("copy"),$("#copy-text-container").remove()}catch(err){return $.jGrowl("Copied to clipboard not supported by this browser."),!1}$.jGrowl('<div class="text-truncate">'+txt+"</div>",{header:"Copied to clipboard",theme:"bg-primary"}),this.clear()}getHighlights(){$.when(model.load({url:window.IL_BASE_URL+"index.php/pdf/highlights",data:{id:$("body").data("id")},async:!0})).done((function(response){$("#pdfviewer-pages").find(".pdfviewer-highlights").remove();let underlinedClass="";"underlined"===store.load("il.highlightStyle")&&(underlinedClass="underlined"),_.forEach(response.highlights,(function(boxes,page){let $con=$("#pdfviewer-pages").find(".pdfviewer-page").eq(page-1);$(boxes).addClass(underlinedClass).insertAfter($con.children("img"))}))}))}showAnnotations(e){let This=e.data.object;0===$("#pdfviewer-pages").find(".pdfviewer-highlights").length&&This.getHighlights(),This.showNotes(e)}hideAnnotations(e){let This=e.data.object;This.clearHighlights(e),This.clearNotes(e)}addHighlights(e){let This=e.data.object,pgNum=This.page;This.clearNotes(e),$(this).hasClass("highlight-blue")?(store.save("il.highlight","B"),$("#pdfviewer-pages").find(".pdfviewer-page").removeClass((function(i,c){return(c.match(/(^|\s)cursor-\S+/g)||[]).join(" ")})).addClass("cursor-marker-blue")):$(this).hasClass("highlight-yellow")?(store.save("il.highlight","Y"),$("#pdfviewer-pages").find(".pdfviewer-page").removeClass((function(i,c){return(c.match(/(^|\s)cursor-\S+/g)||[]).join(" ")})).addClass("cursor-marker-yellow")):$(this).hasClass("highlight-green")?(store.save("il.highlight","G"),$("#pdfviewer-pages").find(".pdfviewer-page").removeClass((function(i,c){return(c.match(/(^|\s)cursor-\S+/g)||[]).join(" ")})).addClass("cursor-marker-green")):$(this).hasClass("highlight-red")&&(store.save("il.highlight","R"),$("#pdfviewer-pages").find(".pdfviewer-page").removeClass((function(i,c){return(c.match(/(^|\s)cursor-\S+/g)||[]).join(" ")})).addClass("cursor-marker-red")),0===$("#pdfviewer-pages").find(".pdfviewer-highlights").length&&This.getHighlights(),void 0===This.selectable&&(This.selectable=new Selectable({lasso:{backgroundColor:"transparent"},lassoSelect:"sequential",appendTo:"#pdfviewer-pages",maxSelectable:1e3})),This.selectable.off("end"),This.selectable.on("end",This.saveHighlights),0===$("#pdfviewer-pages").find(".pdfviewer-text").length&&This.getBoxes(pgNum)}saveHighlights(e,selected){let colClass,This=window.pdfmainview||views.pdfmain,b={},col=store.load("il.highlight");switch(col){case"R":colClass="red";break;case"G":colClass="green";break;case"B":colClass="blue";break;case"Y":colClass="yellow"}_.forEach(selected,(function(o,i){let t,l,w,h,$t=$(o.node),$cont=$t.parent().siblings(".pdfviewer-highlights"),styles=$t.attr("style").split(";");$t.clone().removeClass("ui-selectable ui-selected").addClass(colClass).appendTo($cont),_.forEach(styles,(function(style){let parts=style.split(":");switch(parts[0]){case"top":t=10*parseFloat(parts[1].slice(0,-1));break;case"left":l=10*parseFloat(parts[1].slice(0,-1));break;case"width":w=10*parseFloat(parts[1].slice(0,-1));break;case"height":h=10*parseFloat(parts[1].slice(0,-1))}})),b[i]={page:$t.closest(".pdfviewer-page").data("page"),top:t,left:l,width:w,height:h,position:$t.data("position"),text:$t.attr("data-text")}})),"object"==typeof b[0]&&$.when(model.save({url:window.IL_BASE_URL+"index.php/pdf/savehighlights",data:{id:$("body").data("id"),color:col,boxes:JSON.stringify(b)},async:!0})).done((function(){This.getHighlights()}))}clearHighlights(e){let This=e.data.object,$pages=$("#pdfviewer-pages");$pages.find(".pdfviewer-text").remove(),store.delete("il.highlight"),"object"==typeof This.selectable&&(This.selectable.off("end",This.saveHighlights),This.selectable.destroy(),This.selectable=void 0),$pages.find(".pdfviewer-page").removeClass((function(i,c){return(c.match(/(^|\s)cursor-\S+/g)||[]).join(" ")})),$pages.find(".pdfviewer-highlights").remove()}eraserInit(e){let This=e.data.object,$pages=$("#pdfviewer-pages");$pages.find(".pdfviewer-highlights").length>0&&(void 0===This.selectable&&(This.selectable=new Selectable({lasso:{backgroundColor:"transparent"},lassoSelect:"sequential",appendTo:"#pdfviewer-pages",maxSelectable:1e3})),This.selectable.off("end"),This.selectable.on("end",This.deleteHighlights),0===$pages.find(".pdfviewer-text").length&&This.getBoxes(This.page),$pages.find(".pdfviewer-page").addClass("cursor-eraser"))}deleteHighlights(e,selected){let This=window.pdfmainview||views.pdfmain,b={};_.forEach(selected,(function(o,i){let $t=$(o.node),$cont=$t.parent().siblings(".pdfviewer-highlights"),pos=$t.data("position");$cont.children('[data-position="'+pos+'"]').remove(),b[i]={page:$t.closest(".pdfviewer-page").data("page"),position:pos}})),"object"==typeof b[0]&&$.when(model.save({url:window.IL_BASE_URL+"index.php/pdf/deletehighlights",data:{id:$("body").data("id"),boxes:JSON.stringify(b)},async:!0})).done((function(){This.getHighlights()}))}highlightStyle(){!0===$(this).prop("checked")?($("#pdfviewer-pages").find(".pdfviewer-highlights").addClass("underlined"),store.save("il.highlightStyle","underlined")):($("#pdfviewer-pages").find(".pdfviewer-highlights").removeClass("underlined"),store.save("il.highlightStyle","highlight"))}getLinks(){let sseLinks=new EventSource(IL_BASE_URL+"index.php/pdf/links?id="+$("body").data("id"));sseLinks.onmessage=function(e){if("CLOSE"===e.data||0===$("#pdfviewer-pages").length)sseLinks.close();else{let data=JSON.parse(e.data);_.forEach(data,(function(div,page){$("#pdfviewer-pages").find(".pdfviewer-page").eq(page-1).append(div)}))}}}getBoxes(pgNum){let This=this;$.when(model.load({url:window.IL_BASE_URL+"index.php/pdf/boxes",data:{id:$("body").data("id"),page:pgNum},async:!0})).done((function(response){$("#pdfviewer-pages").find(".pdfviewer-text").remove(),_.forEach(response.boxes,(function(boxes,page){let $con=$("#pdfviewer-pages").find(".pdfviewer-page").eq(page-1);$con.append(boxes),This.selectable.add($con.children(".pdfviewer-text").children().get())}))}))}search(e){if(13!==e.which)return!1;let showProgress,This=e.data.object,$t=$(this),pageCount=$(".pdfviewer-right > div:last-child").data("page"),$noresultsCont=$("#pdfviewer-results > .pdfviewer-no-results-container"),$resultsCont=$("#pdfviewer-results > .pdfviewer-results-container"),$progressBar=$("#pdfviewer-search-progress"),$pagesCont=$("#pdfviewer-pages");$noresultsCont.removeClass("d-none"),$resultsCont.empty(),$pagesCont.find(".pdfviewer-result-boxes").remove(),"object"==typeof This.sseSearch&&2!==This.sseSearch.readyState&&(This.sseSearch.close(),clearTimeout(showProgress),$progressBar.addClass("d-none"),$progressBar.find("div").width("0%").attr("aria-value-now","0%")),showProgress=setTimeout((function(){$progressBar.removeClass("d-none")}),500),This.sseSearch=new EventSource(IL_BASE_URL+"index.php/pdf/search?id="+$("body").data("id")+"&query="+$t.val()),This.sseSearch.onmessage=function(e){if("CLOSE"===e.data||0===$pagesCont.length)This.sseSearch.close(),clearTimeout(showProgress),$progressBar.addClass("d-none"),$progressBar.find("div").width("0%").attr("aria-value-now","0%");else{let response=JSON.parse(e.data);_.forEach(response.boxes,(function(boxes,page){$pagesCont.find(".pdfviewer-page").eq(page-1).children("img").after(boxes)})),_.forEach(response.snippets,(function(snippet){$(snippet).appendTo("#pdfviewer-results > .pdfviewer-results-container"),!1===$noresultsCont.hasClass("d-none")&&$noresultsCont.addClass("d-none")}));let progress=Math.floor(Math.min(100,100*response.last_page/pageCount));$progressBar.find("div").width(progress+"%").attr("aria-value-now",progress+"%"),0===$resultsCont.find("a.bg-dark").length&&$resultsCont.find("a").eq(0).trigger("click").focus()}},This.showResults(),!1===$(".navbar-toggler").is(":visible")&&This.showLeft()}showResults(e){let This="object"==typeof e?e.data.object:this;$("#pdfviewer-thumbs").addClass("d-none"),$("#pdfviewer-bookmarks").addClass("d-none"),$("#pdfviewer-notes").addClass("d-none"),$("#pdfviewer-results").removeClass("d-none"),This.redrawNoteLine(),This.redrawSnippetLine()}scrollToResult(e){let This=e.data.object;$("#pdfviewer-results .snippet").removeClass("bg-dark"),$(this).addClass("bg-dark");let $el=$("#"+$(this).data("box"));This.drawSnippetLine($(this).data("box")),This.scrollToElement($el),$(".pdfviewer-result-boxes > div").removeClass("active"),$el.addClass("active")}nextResult(){let $t=$("#pdfviewer-results a.bg-dark").next();1===$t.length?$t.trigger("click"):$("#pdfviewer-results a").eq(0).trigger("click")}prevResult(){let $t=$("#pdfviewer-results a.bg-dark").prev();1===$t.length?$t.trigger("click"):$("#pdfviewer-results a").last().trigger("click")}showNotes(e){let This=e.data.object;$("#pdfviewer-thumbs").addClass("d-none"),$("#pdfviewer-bookmarks").addClass("d-none"),$("#pdfviewer-notes").removeClass("d-none"),$("#pdfviewer-results").addClass("d-none"),This.redrawSnippetLine(),$.when(model.load({url:window.IL_BASE_URL+"index.php/pdf/notelist",data:{id:$("body").data("id")}})).done((function(response){$("#pdfviewer-notes").html(response.list),_.forEach(response.pages,(function(boxes,page){let $con=$("#pdfviewer-pages").find(".pdfviewer-page").eq(page-1);$con.find(".pdfviewer-notes").remove(),$con.append(boxes)})),$(".pdfnote").tooltip({animation:!1,template:'<div class="tooltip" role="tooltip"><div class="tooltip-inner bg-secondary rounded-0 text-left px-3 py-2 border border-light"></div></div>'}).on("shown.bs.tooltip",(function(){"function"==typeof window.MathJax.typeset&&window.MathJax.typeset(),$(this).tooltip("update")})),$("#pdfviewer-notes").on("click",".note-btn",(function(){let noteId=$(this).data("id");This.scrollToElement($("#pdfnote-"+noteId)),$(".note-btn").removeClass("active"),$(this).addClass("active"),$(".pdfnote").tooltip("hide"),This.drawNoteLine(noteId)})),$(".pdfnote").on("click",(function(){let noteId=$(this).data("id");$("#pdfviewer-notes .note-btn").removeClass("active"),$("#pdfviewer-notes").find('.note-btn[data-id="'+noteId+'"]').addClass("active"),This.drawNoteLine(noteId)})),"function"==typeof window.MathJax.typeset&&window.MathJax.typeset()}))}editNote(e){let $par=$(this).parent();$par.addClass("d-none"),$par.next().removeClass("d-none")}saveNote(e){let This=e.data.object,$f=$(this),note=$f.find("textarea").val(),noteId=$f.parent().data("id")||0,itemId=$("body").data("id");e.preventDefault(),$.when(model.save({url:$f.attr("action"),data:$f.serialize()+"&id="+itemId,async:!0})).done((function(){$f.addClass("d-none"),""===$.trim(note)||0===noteId?This.showNotes(e):($f.prev().removeClass("d-none").find("button").eq(0).text(note),$("#pdfnote-"+noteId).attr("data-title",note).attr("data-original-title",note),"function"==typeof window.MathJax.typeset&&window.MathJax.typeset())}))}createNewNote(e){let This=e.data.object;!0===$(".pdfviewer-page").hasClass("cursor-cross")?This.clearNewNote():(This.clearHighlights(e),This.showNotes(e),This.showLeft(),$(".pdfviewer-page").addClass("cursor-cross"),$(".pdfviewer-page").on("click.createnote",".pdfviewer-notes",(function(e){let left=Math.round(1e3*(e.pageX-$(this).offset().left)/$(this).width()),top=Math.round(1e3*(e.pageY-$(this).offset().top)/$(this).height()),pg=$(this).closest(".pdfviewer-page").data("page"),$f=$("#new-note-form");$f.removeClass("d-none").find('[name="pg"]').val(pg),$f.find('[name="left"]').val(left),$f.find('[name="top"]').val(top),$(".pdfnote.new").remove(),$('<div class="pdfnote new" style="left:'+left/10+"%;top:"+top/10+'%;"></div>').appendTo(this),This.clearNewNote()})))}clearNotes(e){e.data.object.clearNewNote(),$("#pdfviewer-notes").empty(),$("#pdfviewer-pages").find(".pdfviewer-notes").remove()}clearNewNote(){$(".pdfviewer-page").removeClass("cursor-cross"),$(".pdfviewer-page").off("click.createnote")}drawNoteLine(noteId){let $note=$("#pdfnote-"+noteId),$noteBtn=$("#pdfviewer-notes").find('.note-group[data-id="'+noteId+'"]'),noteRect=$note[0].getBoundingClientRect(),noteBtnRect=$noteBtn[0].getBoundingClientRect(),leftPos=noteBtnRect.right,topPos=Math.min(noteBtnRect.top+15,noteRect.top),svgWidth=noteRect.left-noteBtnRect.right,svgHeight=noteRect.top-(noteBtnRect.top+15),hiddenClass="";(null===$noteBtn[0].offsetParent||topPos<50||svgHeight+topPos>$(window).height()||svgWidth<1)&&(hiddenClass="d-none");let flipLine="";svgHeight<0&&(flipLine='transform="scale (-1, 1)" transform-origin="center"',svgHeight=Math.abs(svgHeight)),0===svgHeight&&(svgHeight=1);let line=`\n            <svg\n                id="note-line" data-note-id="${noteId}" class="${hiddenClass}"\n                style="pointer-events: none;position: fixed;width: ${svgWidth}px;height: ${svgHeight}px;top: ${topPos}px;left: ${leftPos}px"\n                viewBox="0 0 ${svgWidth} ${svgHeight}"\n                xmlns="http://www.w3.org/2000/svg">\n                <line x1="0" y1="0" x2="100%" y2="100%"\n                    stroke="rgba(47, 141, 237, 0.75)" stroke-dasharray="0, 6" stroke-width="2" stroke-linecap="round"\n                    ${flipLine} />\n            </svg>`;$("#note-line").remove(),$note.parent().prepend(line)}redrawNoteLine(){let $line=$("#note-line");1===$line.length&&this.drawNoteLine($line.attr("data-note-id"))}drawSnippetLine(snippetId){let $snippet=$("#"+snippetId),$snippetBtn=$(".pdfviewer-results-container").find('[data-box="'+snippetId+'"]'),snippetRect=$snippet[0].getBoundingClientRect(),snippetBtnRect=$snippetBtn[0].getBoundingClientRect(),leftPos=snippetBtnRect.right,topPos=Math.min(snippetBtnRect.top+20,snippetRect.top),svgWidth=snippetRect.left-snippetBtnRect.right,svgHeight=snippetRect.top-(snippetBtnRect.top+20),hiddenClass="";(null===$snippetBtn[0].offsetParent||topPos<50||svgHeight+topPos>$(window).height()||svgWidth<1)&&(hiddenClass="d-none");let flipLine="";svgHeight<0&&(flipLine='transform="scale (-1, 1)" transform-origin="center"',svgHeight=Math.abs(svgHeight)),0===svgHeight&&(svgHeight=1);let line=`\n            <svg\n                id="snippet-line" data-snippet-id="${snippetId}" class="${hiddenClass}"\n                style="pointer-events: none;position: fixed;width: ${svgWidth}px;height: ${svgHeight}px;top: ${topPos}px;left: ${leftPos}px"\n                viewBox="0 0 ${svgWidth} ${svgHeight}"\n                xmlns="http://www.w3.org/2000/svg">\n                <line x1="0" y1="0" x2="100%" y2="100%"\n                    stroke="rgba(255, 0, 255, 0.75)" stroke-dasharray="0, 6" stroke-width="2" stroke-linecap="round"\n                    ${flipLine} />\n            </svg>`;$("#snippet-line").remove(),$snippet.parent().prepend(line)}redrawSnippetLine(){let $line=$("#snippet-line");1===$line.length&&this.drawSnippetLine($line.attr("data-snippet-id"))}openLink(e){let This=e.data.object,href=$(this).data("href");"number"==typeof href?This.scrollToPage(href):window.open(href)}}views.pdfmain=new PdfMainView;class PdfManageView extends View{constructor(){super(),this.parent="#content-col"}afterRender(data){$("#upload-form").uploadable(),$("#delete-pdf").confirmable({submit:function(){let itemId=$("body").data("id");$.when(model.save({url:window.IL_BASE_URL+"index.php/pdf/delete",data:{id:itemId}})).done((function(){B.history.loadUrl()}))}}),$("#reindex-pdf").confirmable({submit:function(){let itemId=$("body").data("id");$.when(model.save({url:window.IL_BASE_URL+"index.php/pdf/extract",data:{id:itemId}})).done((function(){B.history.loadUrl()}))}}),$("#ocr-pdf").confirmable({submit:function(){let $f=$("#ocr-form");$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(){B.history.loadUrl()}))}}),$("body").off("submit.pdfmanage").on("submit.pdfmanage","#ocr-form",(function(e){e.preventDefault()})),"object"==typeof itemview&&(itemview.clickTitle(),itemview.changeTitleLink())}}views.pdfmanage=new PdfManageView;class ImportWizardView extends View{constructor(){super(),this.parent="#content-col"}}views.importwizard=new ImportWizardView;class ImportUidView extends View{constructor(){super(),this.parent="#content-col",this.inputType="",this.events={"click #fetch-record":"fetch","input #uid":"uidResolve","keydown #uid":"preventSubmit"}}afterRender(data){formStyle.init(),$("#upload-form").uploadable(),$("#tag-filter").filterable({complete:function(){$("#content-col .label-text").each((function(){$(this).hasClass("d-none")?$(this).parent().parent().addClass("d-none"):$(this).parent().parent().removeClass("d-none")})),$(".tag-table").find("tr").each((function(){$(this).find(".label-text").length-$(this).find(".label-text.d-none").length==0?$(this).addClass("d-none"):$(this).removeClass("d-none")}))}})}uidResolve(e){let uidVal=$.trim($(this).val());if(!0===/^10\.\d{4}/.test(uidVal))$("#new-uid-type").val("DOI");else if(!0===/^http/i.test(uidVal)){let path=new URL(uidVal).pathname.substr(1);!0===/^10\.\d{4}/.test(path)&&($(this).val(path),$("#new-uid-type").val("DOI"))}else!0===/^pmid:/i.test(uidVal)?$("#new-uid-type").val("PMID"):!0===/^ieee:/i.test(uidVal)?$("#new-uid-type").val("IEEE"):!0===/^arxiv:/i.test(uidVal)?$("#new-uid-type").val("ARXIV"):!0===/^[0-9]{4}.{14}[A-Z]/.test(uidVal)?$("#new-uid-type").val("NASAADS"):!0===/^pmc.*|pmcid:/i.test(uidVal)?$("#new-uid-type").val("PMCID"):!0===/^OL/.test(uidVal)?$("#new-uid-type").val("OL"):!0===/^[A-Z]{2}\d+/.test(uidVal)?$("#new-uid-type").val("PAT"):!0===/^[SP]\d/.test(uidVal)?$("#new-uid-type").val("DIRECT"):!0===/^ISBN:\s?\d/.test(uidVal)?$("#new-uid-type").val("ISBN"):$("#new-uid-type").val("");$("#select-type").collapse("show")}fetch(e){let uid=$.trim($("#uid").val());switch($("#new-uid-type").val()){case"DOI":$.when(model.load({url:window.IL_BASE_URL+"index.php/crossref/fetch",data:{uid:uid}})).done((function(response){let item=response.items[0]||[];void 0===item.title?($("#uid-message").removeClass("d-none").addClass("d-flex"),$("#fetch-record").addClass("d-none"),$("#upload-form").find(".reload-button").removeClass("d-none")):($(".import-wizard-uid").html('Record found:<h5><a href="'+item.urls[0]+'" target="_blank">'+item.title+"</a></h5>"),$(".uploadable-url").val(item.urls[1]||""),$("#metadata").val(JSON.stringify(item)),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit, .reload-button").removeClass("d-none"),$("#phase-2").removeClass("d-none"))})).fail((function(xhr){404===xhr.status&&($("#uid-message").removeClass("d-none").addClass("d-flex"),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit, .reload-button").removeClass("d-none"))}));break;case"PMID":let pmid=uid.replace(/\D/g,"");$.when(model.load({url:"https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&retmode=xml&id="+pmid,cors:!0,dataType:"text"})).done((function(response){$.when(model.save({url:window.IL_BASE_URL+"index.php/pubmed/format",data:{xml:response}})).done((function(response){let item=response.items[0]||[];void 0===item.title?($("#uid-message").removeClass("d-none").addClass("d-flex"),$("#fetch-record").addClass("d-none"),$("#upload-form").find(".reload-button").removeClass("d-none")):($(".import-wizard-uid").html('Record found:<h5><a href="'+item.urls[0]+'" target="_blank">'+item.title+"</a></h5>"),$(".uploadable-url").val(item.urls[1]||""),$("#metadata").val(JSON.stringify(item)),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit, .reload-button").removeClass("d-none"),$("#phase-2").removeClass("d-none"))}))}));break;case"PMCID":let pmcid=$.trim(uid.replace(/pmcid:/gi,""));$.when(model.load({url:"https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pmc&retmode=xml&id="+pmcid,cors:!0,dataType:"text"})).done((function(response){$.when(model.save({url:window.IL_BASE_URL+"index.php/pmc/format",data:{xml:response}})).done((function(response){let item=response.items[0]||[];void 0===item.title?($("#uid-message").removeClass("d-none").addClass("d-flex"),$("#fetch-record").addClass("d-none"),$("#upload-form").find(".reload-button").removeClass("d-none")):($(".import-wizard-uid").html('Record found:<h5><a href="'+item.urls[0]+'" target="_blank">'+item.title+"</a></h5>"),$(".uploadable-url").val(item.urls[1]||""),$("#metadata").val(JSON.stringify(item)),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit, .reload-button").removeClass("d-none"),$("#phase-2").removeClass("d-none"))}))}));break;case"ISBN":let isbn=$.trim(uid.replace(/isbn:/gi,""));$.when(model.load({url:"https://openlibrary.org/api/books?bibkeys=ISBN:"+isbn+"&jscmd=data&format=json",cors:!0,dataType:"text"})).done((function(response){$.when(model.save({url:window.IL_BASE_URL+"index.php/ol/convert",data:{json:response}})).done((function(response){let item=response.items[0]||[];void 0===item.title?($("#uid-message").removeClass("d-none").addClass("d-flex"),$("#fetch-record").addClass("d-none"),$("#upload-form").find(".reload-button").removeClass("d-none")):($(".import-wizard-uid").html('Record found:<h5><a href="'+item.urls[0]+'" target="_blank">'+item.title+"</a></h5>"),$("#metadata").val(JSON.stringify(item)),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit, .reload-button").removeClass("d-none"),$("#phase-2").removeClass("d-none"))}))}));break;case"OL":let olid=$.trim(uid.replace(/isbn:/gi,""));$.when(model.load({url:"https://openlibrary.org/api/books?bibkeys=OLID:"+olid+"&jscmd=data&format=json",cors:!0,dataType:"text"})).done((function(response){$.when(model.save({url:window.IL_BASE_URL+"index.php/ol/convert",data:{json:response}})).done((function(response){let item=response.items[0]||[];void 0===item.title?($("#uid-message").removeClass("d-none").addClass("d-flex"),$("#fetch-record").addClass("d-none"),$("#upload-form").find(".reload-button").removeClass("d-none")):($(".import-wizard-uid").html('Record found:<h5><a href="'+item.urls[0]+'" target="_blank">'+item.title+"</a></h5>"),$("#metadata").val(JSON.stringify(item)),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit, .reload-button").removeClass("d-none"),$("#phase-2").removeClass("d-none"))}))}));break;case"IEEE":let xploreid=uid.replace(/ieee:\s?/i,"");$.when(model.load({url:window.IL_BASE_URL+"index.php/ieee/fetch",data:{uid:xploreid}})).done((function(response){if(0===response.items.length)$("#uid-message").removeClass("d-none").addClass("d-flex"),$("#fetch-record").addClass("d-none"),$("#upload-form").find(".reload-button").removeClass("d-none");else{let item=response.items[0];$(".import-wizard-uid").html('Record found:<h5><a href="https://ieeexplore.ieee.org/document/"'+xploreid+' target="_blank">'+item.title+"</a></h5>"),$("#metadata").val(JSON.stringify(item)),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit, .reload-button").removeClass("d-none"),$("#phase-2").removeClass("d-none")}}));break;case"ARXIV":let arxivid=uid.replace(/arxiv:\s?/i,"");$.when(model.load({url:arxiv.url+arxivid,cors:!0,dataType:"xml"})).done((function(response){let entry=$(response).find("entry"),itemTitle=entry.children("title").text();""===itemTitle?($("#uid-message").removeClass("d-none").addClass("d-flex"),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit, .reload-button").removeClass("d-none")):($(".import-wizard-uid").html('Record found:<h5><a href="'+entry.children("id").text()+'" target="_blank">'+itemTitle+"</a></h5>"),$("#metadata").val(arxiv.metadata($(response))),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit, .reload-button").removeClass("d-none"),$("#phase-2").removeClass("d-none"))})).fail((function(xhr){400===xhr.status&&($("#uid-message").removeClass("d-none").addClass("d-flex"),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit, .reload-button").removeClass("d-none"))}));break;case"NASAADS":$.when(model.load({url:window.IL_BASE_URL+"index.php/nasa/fetch",data:{uid:uid}})).done((function(response){let item=response.items[0]||[];void 0===item.title?($("#uid-message").removeClass("d-none").addClass("d-flex"),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit, .reload-button").removeClass("d-none")):($(".import-wizard-uid").html('Record found:<h5><a href="'+item.urls[0]+'" target="_blank">'+item.title+"</a></h5>"),$(".uploadable-url").val(item.urls[1]||""),$("#metadata").val(JSON.stringify(item)),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit, .reload-button").removeClass("d-none"),$("#phase-2").removeClass("d-none"))}));break;case"PAT":let patentId=uid.replace(/patent:\s?/i,"");$.when(model.load({url:window.IL_BASE_URL+"index.php/patents/fetch",data:{uid:patentId}})).done((function(response){let item=response.items[0]||[];void 0===item.title?($("#uid-message").removeClass("d-none").addClass("d-flex"),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit, .reload-button").removeClass("d-none")):($(".import-wizard-uid").html('Record found:<h5><a href="'+item.urls[0]+'" target="_blank">'+item.title+"</a></h5>"),$(".uploadable-url").val(item.urls[1]||""),$("#metadata").val(JSON.stringify(item)),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit, .reload-button").removeClass("d-none"),$("#phase-2").removeClass("d-none"))}))}}preventSubmit(e){13===e.which&&(e.preventDefault(),e.data.object.fetch())}}views.importuid=new ImportUidView;class ImportFileView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #upload-form":"saveRepository"}}afterRender(data){formStyle.init(),$("#upload-form").uploadable(),$("#tag-filter").filterable({complete:function(){$("#content-col .label-text").each((function(){$(this).hasClass("d-none")?$(this).parent().parent().addClass("d-none"):$(this).parent().parent().removeClass("d-none")})),$(".tag-table").find("tr").each((function(){$(this).find(".label-text").length-$(this).find(".label-text.d-none").length==0?$(this).addClass("d-none"):$(this).removeClass("d-none")}))}}),$("#upload-form").find('input[name="repository"]').val([store.load("il.repository")]),formStyle.updateForm($("#upload-form"))}saveRepository(){store.save("il.repository",$("#upload-form").find('input[name="repository"]:checked').val())}}views.importfile=new ImportFileView;class ImportTextView extends View{constructor(){super(),this.parent="#content-col"}afterRender(data){formStyle.init(),$("#upload-form").uploadable(),$("#tag-filter").filterable({complete:function(){$("#content-col .label-text").each((function(){$(this).hasClass("d-none")?$(this).parent().parent().addClass("d-none"):$(this).parent().parent().removeClass("d-none")})),$(".tag-table").find("tr").each((function(){$(this).find(".label-text").length-$(this).find(".label-text.d-none").length==0?$(this).addClass("d-none"):$(this).removeClass("d-none")}))}})}}views.importtext=new ImportTextView;class ImportManualView extends View{constructor(EditMainView){super(),this.parent="#content-col",this.editmain=EditMainView}afterRender(data){formStyle.init(),$("#upload-form").uploadable({pdftitles:function(e,data){$("#extracted-titles").empty(),data.titles.length>0&&$("#title").val(data.titles.pop())},change:function(e,file){$("#title").val(file.name.substr(0,file.name.lastIndexOf(".")))},clear:function(e){$("#title").val("")}}),this.editmain.uploadFormWidgets(),$("#tag-filter").filterable({complete:function(){$("#content-col .label-text").each((function(){$(this).hasClass("d-none")?$(this).parent().parent().addClass("d-none"):$(this).parent().parent().removeClass("d-none")})),$(".tag-table").find("tr").each((function(){$(this).find(".label-text").length-$(this).find(".label-text.d-none").length==0?$(this).addClass("d-none"):$(this).removeClass("d-none")}))}})}}views.importmanual=new ImportManualView(views.editmain);class ExternalMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit .search-form":"search","click .delete-search":"deleteSearch","click .edit-search":"loadForm"}}afterRender(data){formStyle.init(),$(".clone-button").clonable({target:"#search-row"}),$(this.parent).find("form").saveable()}search(e){e.preventDefault(),$(this).saveable("save");let params=$(this).serialize();router.navigate($(this).attr("action")+"?"+params,{trigger:!0})}deleteSearch(e){let $t=$(this);$.when(model.save({url:$t.data("url"),data:{id:$t.data("id")}})).done((function(){B.history.loadUrl()}))}loadForm(){let href=$(this).closest(".list-group-item").find("a").attr("href"),entries=new URL("http://foo.bar/"+href.substr(1)).searchParams.entries(),result=[];for(let entry of entries){const[key,val]=entry;""!==val&&result.push({name:key,value:val})}let $f=$("#content-col").find("form");$f.saveable("saveParams",result),$f.saveable("load")}}views.ieeemain=new ExternalMainView,views.arxivmain=new ExternalMainView,views.crossrefmain=new ExternalMainView,views.pubmedmain=new ExternalMainView,views.pmcmain=new ExternalMainView,views.nasamain=new ExternalMainView,views.patentsmain=new ExternalMainView,views.sciencedirectmain=new ExternalMainView,views.scopusmain=new ExternalMainView;class ExternalSearchView extends View{constructor(){super(),this.parent="#content-col",this.events={"click .add-pdf-btn":"makeUploadable","click button":"makeUploadable"}}afterRender(data){formStyle.init(),$(window).off("resize.ExternalSearchView").on("resize.ExternalSearchView",(function(){views.itemsmain.itemsHeight()})),views.itemsmain.itemsHeight(),$("#content-col .tag-filter").filterable({complete:function(){let $par=$(this).closest(".collapse"),$tab=$(this).closest(".collapse").find("table");$par.find(".label-text").each((function(){$(this).hasClass("d-none")?$(this).parent().parent().addClass("d-none"):$(this).parent().parent().removeClass("d-none")})),$tab.find("tr").each((function(){$(this).find(".label-text").length-$(this).find(".label-text.d-none").length==0?$(this).addClass("d-none"):$(this).removeClass("d-none")}))}})}makeUploadable(){$(this).closest("form").uploadable()}}views.ieeesearch=new ExternalSearchView,views.arxivsearch=new ExternalSearchView,views.crossrefsearch=new ExternalSearchView,views.pubmedsearch=new ExternalSearchView,views.pmcsearch=new ExternalSearchView,views.nasasearch=new ExternalSearchView;class GlobalSettingsMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #settings-form":"submitForm"}}afterRender(data){formStyle.init()}submitForm(e){e.preventDefault();let $f=$(this),pacUrl=$.trim($("#wpad-url").val());!0===$("#connection-url").prop("checked")&&""!==pacUrl?$.getScript(pacUrl,(function(){let proxystr=FindProxyForURL("","www.crossref.org"),proxyurl="",parts=proxystr.split(";");_.forEach(parts,(function(part){if(0===_.trim(part).indexOf("PROXY"))return proxyurl=part.substr(6),$("#proxy-pac").val(proxyurl),!1})),$.when(model.save({url:$f.attr("action"),data:$f.serialize()}))})).fail((function(){$.jGrowl("Unable to fetch the PAC/WPAD file.",{header:"Error",theme:"bg-danger"})})):$.when(model.save({url:$f.attr("action"),data:$f.serialize()}))}}views.globalsettingsmain=new GlobalSettingsMainView;class UsersMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"click .update-user":"updateUser","click #create-user":"createUser"}}afterRender(data){$(".reset-password").confirmable({submit:this.resetPassword})}updateUser(){let $par=$(this).closest("tr"),email=$par.find(".email").val();""!==$.trim(email)?$.when(model.save({url:window.IL_BASE_URL+"index.php/users/update",data:{user:{username:$par.find(".username").text(),first_name:$par.find(".first-name").val(),last_name:$par.find(".last-name").val(),email:email,permissions:$par.find(".permissions").val(),status:$par.find(".status").val()}}})).done((function(){B.history.loadUrl()})):$.jGrowl("Email is required.",{header:"Info",theme:"bg-primary"})}createUser(){let $par=$(this).closest("tr"),email=$par.find(".email").val();""!==$.trim(email)?$.when(model.save({url:window.IL_BASE_URL+"index.php/users/create",data:{user:{username:$par.find(".username").val(),first_name:$par.find(".first-name").val(),last_name:$par.find(".last-name").val(),email:email,permissions:$par.find(".permissions").val()}}})).done((function(response){"string"==typeof response.password&&$.jGrowl(response.password,{sticky:!0,theme:"bg-dark text-light"}),B.history.loadUrl()})):$.jGrowl("Email is required.",{header:"Info",theme:"bg-primary"})}resetPassword(){let $par=$(this).closest("tr"),email=$par.find(".email").val();""!==$.trim(email)?$.when(model.save({url:window.IL_BASE_URL+"index.php/users/reset",data:{user:{username:$par.find(".username").text(),email:email}}})).done((function(response){"string"==typeof response.password&&$.jGrowl(response.password,{sticky:!0,theme:"bg-dark"})})):$.jGrowl("User's email is required to reset password.",{header:"Info",theme:"bg-primary"})}}views.usersmain=new UsersMainView;class DetailsMainView extends View{constructor(){super(),this.parent="#content-col"}}views.detailsmain=new DetailsMainView;class LogsMainView extends View{constructor(){super(),this.parent="#content-col"}}views.logsmain=new LogsMainView;class CitationMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #form-new-csl":"submitForm"}}afterRender(data){window.tables["table-csl"]=$("#table-csl").DataTable({deferRender:!0,data:data.styles,columnDefs:[{orderable:!1,targets:2}]}),$("#modal-csl").off("shown.bs.modal").on("shown.bs.modal",(function(e){$("#modal-csl").find(".modal-title").text($(e.relatedTarget).attr("data-name")),$.when(model.load({url:window.IL_BASE_URL+"index.php/citation/get",data:{id:$(e.relatedTarget).attr("data-id")}})).done((function(response){$("#modal-csl").find("code").html(response.csl)}))}))}submitForm(e){e.preventDefault();let $f=$(this);$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(){$f[0].reset()}))}}views.citationmain=new CitationMainView;class MainView{constructor(){sidebar.init(),""!==location.hash&&"#"!==location.hash||1!==$("#side-menu").length||router.navigate("dashboard/main",{trigger:!0,replace:!0}),$("#signin-form").on("submit",(function(e){e.preventDefault();let $f=$(this),enRef=new URL(window.location.href).searchParams.get("ref");""!==$.trim($f.find('[name="username"]').val())&&""!==$.trim($f.find('[name="password"]').val())&&$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(response){if(void 0===response.info)if("string"==typeof enRef){let ref=window.atob(enRef);new URL(ref).hostname===location.hostname?location.replace(ref):location.replace(IL_BASE_URL+"index.php/#dashboard/main")}else location.replace(IL_BASE_URL+"index.php/#dashboard/main")}))})),$("#migrate-form").on("submit",(function(e){e.preventDefault();let $f=$(this);$.when(model.load({url:$f.attr("action")+"?"+$f.serialize()})).done((function(response){void 0===response.info&&location.replace(window.IL_BASE_URL)}))})),$("#sign-out").on("click",(function(){$.when(model.save({url:window.IL_BASE_URL+"index.php/authentication/signout"})).done((function(){location.assign(window.IL_BASE_URL)}))})),$(".modal-content").draggable({containment:"document",handle:".modal-header"}),$("#keyboard-toggle").on("click",(function(){keyboard.init()})),$("#content-col").on("click","#open-settings",(function(){""===$.trim($("#modal-settings").find(".modal-body").html())&&$.when(model.load({url:window.IL_BASE_URL+"index.php/settings/display"})).done((function(response){$("#modal-settings").find(".modal-body").html(response.html),formStyle.init()}))})),$("#modal-settings .modal-footer button").eq(0).on("click",(function(e){$("#modal-settings form").trigger("submit")})),$("#modal-settings").on("submit","form",(function(e){e.preventDefault();let $f=$(this);$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(){B.history.loadUrl()})),$("#modal-settings").modal("hide")})),searchlist.init()}}class MigrationView{constructor(){$("#migrate-form").on("submit",(function(e){e.preventDefault();let $f=$(this);$.when(model.load({url:$f.attr("action")+"?"+$f.serialize()})).done((function(response){void 0===response.info&&location.replace(window.IL_BASE_URL)}))}))}}class RegistrationView{constructor(){$("#signup-form").on("submit",(function(e){e.preventDefault();let $f=$(this);$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(response){void 0===response.info&&location.assign(window.IL_BASE_URL)}))}))}}class ResetpasswordView{constructor(){$("form").on("submit",(function(e){e.preventDefault();let $f=$(this);$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(response){$(".container-fluid").html(response.html)}))})),$("body").on("click","#new-password",(function(){let sel=window.getSelection(),range=document.createRange();range.selectNodeContents($("#new-password")[0]),sel.removeAllRanges(),sel.addRange(range)}))}}class ItemView{constructor(){sidebar.init();let backURL="string"==typeof store.load("il.itemReferrer")?store.load("il.itemReferrer"):window.IL_BASE_URL+"#items/main";$("#item-back-link").attr("href",backURL);let anId=new URL("http://foo.bar/"+location.hash.substring(1)).searchParams.get("id")||"";$("body").attr("data-id",anId).data("id",anId),$("#id-hidden").val(anId),$("a.add-id-link").each((function(){let thisHParts=$(this).attr("href").split("id=");$(this).attr("href",thisHParts[0]+"id="+anId)})),$("#keyboard-toggle").on("click",(function(){keyboard.init()})),$("#sign-out").on("click",(function(){$.when(model.save({url:window.IL_BASE_URL+"index.php/authentication/signout"})).done((function(){location.assign(window.IL_BASE_URL)}))}));let itemList=sessionStore.load("il.idList");if(null===itemList||itemList.length<2)$("#left-item-list").addClass("d-none");else{let $l=$("#left-item-list .left-item-link").detach(),href=$l.attr("href");itemList.forEach((function(v){let isActive=v.id===anId?"bg-darker-10":"";$l.clone().addClass(isActive).attr("href",href.replace("{ID}",v.id)).attr("data-id",v.id).html(v.title).appendTo("#left-item-list")})),$l=void 0,$("#left-item-list").removeClass("d-none").hide().fadeIn()}}clickTitle(){let $par=$("#left-item-list"),$activeLink=$("#left-item-list .left-item-link.bg-darker-10");if(0===$activeLink.length)return $par.addClass("d-none"),void sessionStore.delete("il.idList");if($par.hasClass("d-none"))return;let anId=new URL("http://foo.bar/"+location.hash.substring(1)).searchParams.get("id")||"";$("#left-item-list .left-item-link").each((function(){$(this).removeClass("bg-darker-10"),$(this).attr("data-id")===anId&&$(this).addClass("bg-darker-10")}));let activePos=$activeLink.position().top,parTop=$par.scrollTop(),activeBox=$activeLink[0].getBoundingClientRect(),parBox=$par[0].getBoundingClientRect();(activeBox.top<10||parBox.bottom-activeBox.bottom<10)&&$par.animate({scrollTop:parTop+activePos-$(window).height()/3},250),$("a.add-id-link").each((function(){let thisHParts=$(this).attr("href").split("id=");$(this).attr("href",thisHParts[0]+"id="+anId)})),$("body").attr("data-id",anId).data("id",anId),1===$("#id-hidden").length&&$("#id-hidden").val()!==anId&&$.when(model.load({url:window.IL_BASE_URL+"index.php/notes/user",data:{id:anId}})).done((function(response){$("#notes-ta").val(response.user.note),$("#id-hidden").val(anId),null!==window.tinymce.activeEditor&&!0===window.tinymce.activeEditor.initialized&&window.tinymce.activeEditor.load()}))}changeTitleLink(){if($("#left-item-list").hasClass("d-none"))return;let href="#"+new URL("http://foo.bar/"+location.hash.substring(1)).pathname.substring(1);$("#left-item-list .left-item-link").each((function(){$(this).attr("href",href+"?id="+$(this).attr("data-id"))}))}}class ProjectView{constructor(){sidebar.init();let anId=new URL("http://foo.bar/"+location.hash.substring(1)).searchParams.get("id")||"";$("body").attr("data-id",anId).data("id",anId),$("a.add-id-link").each((function(){let thisHParts=$(this).attr("href").split("id=");$(this).attr("href",thisHParts[0]+"id="+anId)})),$("#id-hidden").val(anId),$("#content-col").on("click",".open-notes",{object:this},this.openNotes),$("#keyboard-toggle").on("click",(function(){keyboard.init()})),$("#content-col").on("click","#open-settings",(function(){""===$.trim($("#modal-settings").find(".modal-body").html())&&$.when(model.load({url:window.IL_BASE_URL+"index.php/settings/display"})).done((function(response){$("#modal-settings").find(".modal-body").html(response.html),formStyle.init()}))})),$("#modal-settings .modal-footer button").eq(0).on("click",(function(e){$("#modal-settings form").trigger("submit")})),$("#modal-settings").on("submit","form",(function(e){e.preventDefault();let $f=$(this);$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(){B.history.loadUrl()})),$("#modal-settings").modal("hide")})),$("#sign-out").on("click",(function(){$.when(model.save({url:window.IL_BASE_URL+"index.php/authentication/signout"})).done((function(){location.assign(window.IL_BASE_URL)}))})),searchlist.init()}openNotes(e){null!==window.tinymce.activeEditor&&!0===window.tinymce.activeEditor.initialized?$("#notes-window").removeClass("d-none"):e.data.object.loadNotes()}loadNotes(){let This=this,projectId=$("body").data("id");$.when(model.load({url:window.IL_BASE_URL+"index.php/project/usernotes",data:{id:projectId}})).done((function(response){$("#notes-ta").val(response.user.note),This.initNotes()}))}initNotes(){window.tinymce.init({theme:"silver",selector:"#notes-ta",content_css:window.IL_BASE_URL+"css/style.css",resize:"both",min_width:300,min_height:300,menubar:!1,plugins:"importcss save lists advlist link image code fullscreen table searchreplace",toolbar1:"save undo redo fullscreen code | formatselect link unlink image table searchreplace",toolbar2:"bold italic underline strikethrough subscript superscript removeformat | forecolor backcolor | outdent indent bullist numlist",save_onsavecallback:function(editor){let $f=$("#note-form");$.when(model.save({url:$f.attr("action"),data:$f.serialize()})).done((function(){$("#user-note").html(editor.getContent()),"function"==typeof window.MathJax.typeset&&window.MathJax.typeset()}))},image_description:!1,relative_urls:!1,remove_script_host:!1,image_dimensions:!1,image_class_list:[{title:"Auto width",value:"mce-img-fluid"}]}).then((function(){let $nw=$("#notes-window");$nw.removeClass("d-none"),$nw.position({my:"left bottom",at:"left bottom",of:"#content-col"}),$(window).off("resize.notes").on("resize.notes",(function(){$("#notes-window").position({my:"left bottom",at:"left bottom",of:"#content-col"})})),$nw.draggable({handle:".card-header",containment:"body"}),$nw.find(".close").off("click.notes").on("click.notes",(function(){$("#notes-window").addClass("d-none")}))}))}}$((function(){B.history.start(),$("body").on("click","a",(function(){let href=$(this).attr("href");return href.indexOf("//")>0||0===href.indexOf("mailto")||0===href.indexOf("data")?(!0===/\/item#/.test(href)&&store.save("il.itemReferrer",location.href),!0):"#"!==href&&""!==href&&void router.navigate(href,{trigger:!0})})),$("body").on("click","#abort-request",(function(){model.abort()})),$(document).on("keydown.hotkeys",null,"a",(function(){$(".navigation-left").trigger("click")})),$(document).on("keydown.hotkeys",null,"w",(function(){$(".navigation-left").trigger("click")})),$(document).on("keydown.hotkeys",null,"d",(function(){$(".navigation-right").trigger("click")})),$(document).on("keydown.hotkeys",null,"s",(function(){$(".navigation-right").trigger("click")})),$(document).on("keydown.hotkeys",null,"esc",(function(){1===$("#pdfviewer-menu").length&&"object"==typeof views.pdfmain&&(views.pdfmain.destroyCropper(),views.pdfmain.destroyTextLayer(),views.pdfmain.clearNewNote(),$("#pdfviewer-highlight-menu .highlight-cancel").click()),1===$("#pdfviewer-menu").length&&"object"==typeof window.pdfmainview&&(window.pdfmainview.destroyCropper(),window.pdfmainview.destroyTextLayer(),window.pdfmainview.clearNewNote(),$("#pdfviewer-highlight-menu .highlight-cancel").click())})),$(document).on("keydown.hotkeys",null,"h",(function(){1===$("#pdfviewer-menu").length&&($(".left-container, #pdfviewer-menu").toggleClass("d-none"),$(window).trigger("resize.PdfMainView"))}))}));